<head>
  <meta charset="UTF-8" />
  <!-- ‚úÖ Mobil: responsiv, ingen pinch-zoom (du kan √§ndra om du vill) -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>H√ÑNGA GUBBE</title>

  <!-- ‚úÖ Fonts & Firebase SDKs -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>

  <style>
    /* ===========================================================
       THEME & GLOBALS
       =========================================================== */
    :root{
      --grad-a:#ec4899; --grad-b:#a855f7;
      --bg1:#0e0e11; --bg2:#1a1a1f;
      --panel:rgba(255,255,255,.08);
      --text:#fff; --text-dim:#bdbdbd;
      --ok:#22c55e; --bad:#ef4444;
      --gap:10px;
    }
    *{box-sizing:border-box}
    html, body { height:100%; }
    body{
      margin:0; font-family:"Poppins",sans-serif; color:var(--text);
      background: radial-gradient(circle at 20% 20%, #18181d, #0e0e11 70%), linear-gradient(160deg, var(--bg1), var(--bg2));
      min-height:100dvh; display:grid; place-items:center; padding:10px;
      overflow-x:hidden;            /* ‚úÖ Ingen horisontell scroll */
      -webkit-tap-highlight-color: transparent;
    }
    h1{
      font-weight:700; text-align:center; margin:0;
      font-size:clamp(1.25rem, 2.8vw, 1.75rem);
      background:linear-gradient(135deg,var(--grad-a),var(--grad-b));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    }
    .card{
      width:min(1000px, 98vw);
      height:min(96dvh, 880px);
      background:var(--panel);
      border-radius:18px; backdrop-filter:blur(12px);
      box-shadow:0 0 25px rgba(0,0,0,.6);
      padding:12px; position:relative;
      display:flex; flex-direction:column; gap:var(--gap); overflow:hidden;
    }
    .hidden{display:none !important}

    /* ===========================================================
       FORMS & BUTTONS (Startsk√§rm)
       =========================================================== */
    .stack > *{display:block; width:100%; margin-top:12px}
    .row{display:flex; gap:10px; align-items:center}
    .row > *{flex:1}
    label{font-size:.95rem; color:var(--text-dim)}
    input,select,button{
      font-family:inherit; font-size:1rem; border-radius:12px; border:1px solid #333; padding:.8rem 1rem;
      background:#222; color:#fff; display:block; width:100%;
    }
    select{background:#1f1f24}
    button{
      cursor:pointer; font-weight:700; color:#111; border:none; background:linear-gradient(135deg,var(--grad-a),var(--grad-b));
      box-shadow:0 6px 18px rgba(168,85,247,.25); transition:transform .15s ease, box-shadow .15s ease;
    }
    button:hover{transform:translateY(-2px); box-shadow:0 8px 22px rgba(168,85,247,.35)}
    .btn-ghost{background:transparent; color:var(--text); border:1px solid #3a3a3f; box-shadow:none}
    .start-icons{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px}
    .tag{font-size:.75rem; color:#111; background:rgba(255,255,255,.55); padding:.1rem .45rem; border-radius:999px; margin-left:.5rem}

    /* ===========================================================
       LOBBY BAR (Sticky med pulserande n√§rvaro)
       =========================================================== */
    #lobbyBar{
      position:sticky; top:0; z-index:5;
      background:linear-gradient(0deg, rgba(0,0,0,.0), rgba(0,0,0,.12));
      border:1px solid #2b2b30; border-radius:12px;
      padding:8px 10px; display:flex; gap:12px; justify-content:center; align-items:center;
      backdrop-filter:blur(10px);
    }
    .lobbyItem{display:flex; align-items:center; gap:8px; font-size:.95rem; white-space:nowrap}
    .dot{width:10px; height:10px; border-radius:999px; display:inline-block; animation:pulseDot 1.4s ease-in-out infinite}
    .online{background:#22c55e}
    .offline{background:#ef4444}
    @keyframes pulseDot{0%{transform:scale(1);opacity:.9}50%{transform:scale(1.15);opacity:1}100%{transform:scale(1);opacity:.9}}
    #lobbyMsg{font-size:.9rem; color:var(--text-dim)}

    /* ===========================================================
       LOADING
       =========================================================== */
    .loading{display:flex; align-items:center; justify-content:center; gap:10px; color:var(--text-dim); padding:6px 0}
    .spinner{width:18px;height:18px;border:3px solid rgba(255,255,255,.2); border-top-color:#fff; border-radius:50%; animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* ===========================================================
       GAME MAIN ‚Äì vertikal scroll, 16:9-k√§nsla p√• desktop
       =========================================================== */
    #gameMain{
      flex:1; display:flex; flex-direction:column;
      gap:12px; overflow-y:auto; overflow-x:hidden; padding:6px;
      scroll-behavior:smooth;
      max-width:900px;         /* ‚úÖ Desktop: 16:9-look */
      margin:0 auto;
    }
    /* ‚úÖ Spacing-guide i botten p√• mobil (s√§kerhetsmarginal + iPhone-safe-area) */
    @media (max-width: 600px){
      #gameMain{ padding-bottom: calc(30px + env(safe-area-inset-bottom)); }
    }
    @media (max-width: 400px){
      #gameMain{ padding-bottom: calc(40px + env(safe-area-inset-bottom)); }
    }

    #share{font-size:.9rem; color:var(--text-dim); word-break:break-all; text-align:center}
    #scoreboard{
      margin-top:2px; font-weight:700; text-align:center; font-size:clamp(1rem,2.6vw,1.2rem);
      background:linear-gradient(135deg,var(--grad-a),var(--grad-b));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    }
    #turnIndicator{margin-top:2px; text-align:center; font-weight:600; color:var(--text-dim); transition:opacity .25s, transform .25s}
    .turn-flash{opacity:0; transform:translateY(-4px)}

    /* ===========================================================
       CANVAS + ORD (extra luft)
       =========================================================== */
    #hangman{
      width:100%; aspect-ratio:200/250; background:#111; border:1px solid #333; border-radius:12px;
      max-height:40dvh; min-height:220px;
    }
    .shake{animation:shake .3s ease}
    @keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-4px)}50%{transform:translateX(4px)}75%{transform:translateX(-3px)}100%{transform:translateX(0)}}

    #word{
      letter-spacing:.25em; font-size:clamp(1.05rem,4vw,1.6rem); text-align:center;
      margin-top:12px;                /* ‚úÖ extra luft ovanf√∂r ordet */
      margin-bottom:20px;             /* ‚úÖ extra luft under ordet */
    }

    /* ===========================================================
       TIMER (luftigare spacing)
       =========================================================== */
    #timerBar{
      margin:10px 0 14px;             /* ‚úÖ mer luft mot letters */
      width:100%; height:11px; border-radius:999px; background:rgba(255,255,255,.08);
      overflow:hidden; display:none
    }
    #timerFill{height:100%; width:0%; background:linear-gradient(90deg,var(--grad-a),var(--grad-b)); transition:width .2s linear, filter .2s linear}
    .pulse{animation:pulse 0.8s ease-in-out infinite}
    @keyframes pulse{0%{filter:brightness(1)}50%{filter:brightness(1.5)}100%{filter:brightness(1)}}

    /* ===========================================================
       LETTERS ‚Äì smalare & responsiva, tydlig luft
       =========================================================== */
    #letters{
      display:grid;
      gap:10px;                       /* ‚úÖ luftigare mellanrum */
      margin-top:16px;                /* ‚úÖ mer luft ovan */
      margin-bottom:28px;             /* ‚úÖ mer luft under (f√∂re chatten) */
    }
    /* Desktop (default): 12 kolumner, n√•got smalare knappar */
    #letters{ grid-template-columns:repeat(12, 1fr); }
    #letters button{
      padding:.45rem .2rem;           /* ‚úÖ smalare */
      border-radius:10px; color:#111; font-weight:800; border:none;
      background:linear-gradient(135deg,var(--grad-a),var(--grad-b));
      box-shadow:0 6px 18px rgba(168,85,247,.25);
      font-size:.95rem;               /* ‚úÖ desktop-typografi */
      transition:transform .15s ease, box-shadow .15s ease, filter .15s ease;
    }
    #letters button:disabled{opacity:.35; filter:saturate(.7); cursor:default}

    /* ‚ú® Hover glow ‚Äì endast p√• enheter med riktig hover (PC, laptops) */
    @media (hover:hover) and (pointer:fine){
      #letters button:hover:not(:disabled){
        box-shadow:0 0 12px rgba(236,72,153,.7), 0 0 18px rgba(168,85,247,.6);
        transform:translateY(-3px) scale(1.04);
      }
    }

    /* Tablet & Mobil: f√§rre kolumner, responsiva storlekar */
    @media (max-width: 959px){
      #letters{ grid-template-columns:repeat(8, 1fr); }
      #letters button{
        font-size:clamp(.9rem, 3.4vw, 1.05rem);
        padding:.5rem .16rem;         /* ‚úÖ lite mer vertikal yta f√∂r touch */
      }
    }
    @media (max-width: 600px){
      #letters{ grid-template-columns:repeat(7, 1fr); gap:9px; }
      #hangman{ max-height:38dvh; }   /* ‚úÖ ger mer utrymme nedan */
    }
    @media (max-width: 420px){
      #letters{ grid-template-columns:repeat(6, 1fr); gap:8px; }
    }

    /* ===========================================================
       CHAT ‚Äì alltid under letters, mer luft ovan
       =========================================================== */
    #chatWrap{border:1px solid #2b2b30; border-radius:12px; background:rgba(255,255,255,.05); padding:10px; display:flex; flex-direction:column; gap:8px; min-height:120px}
    #chatList{flex:1; min-height:72px; max-height:24dvh; overflow-y:auto; overflow-x:hidden; display:flex; flex-direction:column; gap:6px}
    .chatMsg{background:rgba(255,255,255,.06); border:1px solid #35353a; border-radius:10px; padding:6px 8px; font-size:.95rem; line-height:1.25; opacity:1; transition:opacity .6s ease}
    .chatMsg.fadeout{opacity:0}
    .chatMeta{font-size:.75rem; color:var(--text-dim); margin-top:2px}
    #chatRow{display:flex; gap:8px}
    #chatText{background:#222; color:#fff; border:1px solid #333; border-radius:10px; padding:.6rem .9rem; flex:1}
    #chatSend{min-width:110px}
    #chatRow button{width:auto; flex:0 0 auto;} /* ‚úÖ hindrar bred knapp som orsakar hor-scroll */

    /* ===========================================================
       ACTIONS
       =========================================================== */
    #actions{display:flex; gap:8px; justify-content:center; flex-wrap:wrap}
    .action{padding:.7rem 1rem; border-radius:12px; border:none; font-weight:700; cursor:pointer;
      background:linear-gradient(135deg,var(--grad-a),var(--grad-b)); color:#111; box-shadow:0 6px 18px rgba(168,85,247,.25)}
    .action.btn-ghost{background:transparent; color:var(--text); border:1px solid #3a3a3f; box-shadow:none}

    /* ===========================================================
       NICKNAME MODAL (blockerande)
       =========================================================== */
    #nameModal{
      position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:9999;
      padding:16px;
    }
    #nameModal .modal{
      width:min(440px, 92vw); background:rgba(20,20,24,.97); border:1px solid #333; border-radius:14px; padding:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.6);
    }
    #nameModal h2{margin:0 0 8px; font-size:1.1rem}
    #nameModal p{margin:0 0 10px; color:var(--text-dim); font-size:.95rem}
    #nameModal input{width:100%}
    #nameModal .row{margin-top:10px}
  </style>
</head>
<body>

  <!-- ====================== START-SK√ÑRM ====================== -->
  <div id="start" class="card">
    <h1>H√ÑNGA GUBBE</h1>

    <div class="stack">
      <div>
        <label for="lang">Spr√•k / Language</label>
        <select id="lang">
          <option value="sv">Svenska</option>
          <option value="en">English</option>
        </select>
      </div>

      <div>
        <label for="playerName" id="nameLabel">Ditt namn</label>
        <input id="playerName" placeholder="Ditt namn / Your name" maxlength="24"/>
      </div>

      <div class="start-icons">
        <button id="createBtn">üÜï Skapa spel</button>
        <button id="joinBtn">üîó G√• med i spel</button>
      </div>

      <div id="joinArea" class="row hidden">
        <input id="joinCode" placeholder="Spelkod (t.ex. ab123)" maxlength="10"/>
        <button id="joinGo">G√• med</button>
      </div>
    </div>
  </div>


  <!-- ====================== SPEL ====================== -->
  <div id="game" class="card hidden">

    <!-- ‚úÖ Sticky lobby -->
    <div id="lobbyBar">
      <div class="lobbyItem">
        <span id="dotHost" class="dot offline"></span>
        üëë <span id="nameHost">‚Äî</span>
      </div>

      <div class="lobbyItem">
        <span id="dotGuest" class="dot offline"></span>
        üë§ <span id="nameGuest">‚è≥ V√§ntar p√• spelare‚Ä¶</span>
      </div>

      <div id="lobbyMsg" class="lobbyItem" style="color:var(--text-dim)">‚Äî</div>
    </div>


    <div id="gameMain">

      <h1>H√ÑNGA GUBBE</h1>

      <!-- ‚úÖ Loading-status (n√§r man joinar spel eller deep linkar) -->
      <div id="loading" class="loading hidden">
        <div class="spinner"></div>
        <div id="loadingText">Laddar spel‚Ä¶</div>
      </div>

      <!-- ‚úÖ Delningsl√§nk -->
      <div id="share"></div>

      <!-- ‚úÖ Resultatpo√§ng -->
      <div id="scoreboard">üßë 0 | üë§ 0</div>

      <!-- ‚úÖ Tur-indikator -->
      <div id="turnIndicator">‚è≥ V√§ntar p√• tur‚Ä¶</div>


      <!-- ‚úÖ Canvas: h√§nga gubbe -->
      <canvas id="hangman"></canvas>

      <!-- ‚úÖ Ordet -->
      <div id="word">_</div>


      <!-- ====================== TIMER ====================== -->
      <div class="row" id="timerControlsRow" style="justify-content:center; flex-wrap:wrap">
        <button id="timerOpen" class="action hidden" style="max-width:220px">‚è± St√§ll in timer</button>

        <div id="timerConfig" class="row hidden" style="max-width:520px; width:100%;">
          <input id="timerInput" type="number" min="0" max="100" value="0"/>
          <button id="timerConfirm" class="action">‚úÖ</button>
          <button id="timerCancel" class="action btn-ghost">‚úñ</button>
          <button id="timerOff" class="action btn-ghost">üïí Av</button>
        </div>
      </div>

      <!-- ‚úÖ Timer-stapel -->
      <div id="timerBar"><div id="timerFill"></div></div>


      <!-- ‚úÖ Bokst√§ver -->
      <div id="letters"></div>


      <!-- ====================== CHAT (alltid synlig) ====================== -->
      <div id="chatWrap">
        <div id="chatList"></div>
        <div id="chatRow">
          <input id="chatText" placeholder="Skriv ett meddelande..." maxlength="200"/>
          <button id="chatSend">Skicka</button>
        </div>
      </div>


      <!-- ====================== ACTIONS ====================== -->
      <div id="actions">
        <button id="restartBtn" class="action hidden">üîÅ Spela igen</button>
        <button id="newWordBtn" class="action hidden">‚úçÔ∏è V√§lj nytt ord</button>
        <button id="backBtn" class="action">‚¨ÖÔ∏è Tillbaka till start</button>
      </div>

    </div> <!-- gameMain -->

  </div> <!-- game-card -->


  <!-- ====================== NICKNAME-MODAL ====================== -->
  <div id="nameModal">
    <div class="modal">
      <h2 id="nameModalTitle">V√§lj ett namn</h2>
      <p id="nameModalDesc">Du m√•ste ange ett namn f√∂r att g√• vidare.</p>
      <input id="nameModalInput" maxlength="24"/>
      <div class="row">
        <button id="nameModalConfirm">OK</button>
      </div>
    </div>
  </div>

</body>
<script>
/* ===========================================================
   Firebase
=========================================================== */
const firebaseConfig = {
  apiKey: "AIzaSyAN9URR47HIBwIuBP3kSu5Rv_Ys0ef72-Q",
  authDomain: "hangman-6a99e.firebaseapp.com",
  databaseURL: "https://hangman-6a99e-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "hangman-6a99e",
  storageBucket: "hangman-6a99e.firebasestorage.app",
  messagingSenderId: "992689481911",
  appId: "1:992689481911:web:6461e931ba4d96879ec532"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ===========================================================
   DOM refs
=========================================================== */
const startDiv  = document.getElementById("start");
const gameDiv   = document.getElementById("game");
const gameMain  = document.getElementById("gameMain");

const langSel   = document.getElementById("lang");
const nameInput = document.getElementById("playerName");
const nameLabel = document.getElementById("nameLabel");

const createBtn = document.getElementById("createBtn");
const joinBtn   = document.getElementById("joinBtn");
const joinArea  = document.getElementById("joinArea");
const joinCodeInput = document.getElementById("joinCode");
const joinGo    = document.getElementById("joinGo");

const nameHost  = document.getElementById("nameHost");
const nameGuest = document.getElementById("nameGuest");
const dotHost   = document.getElementById("dotHost");
const dotGuest  = document.getElementById("dotGuest");
const lobbyMsg  = document.getElementById("lobbyMsg");

const loading   = document.getElementById("loading");
const loadingText = document.getElementById("loadingText");
const shareEl   = document.getElementById("share");
const scoreEl   = document.getElementById("scoreboard");
const turnEl    = document.getElementById("turnIndicator");

const canvas    = document.getElementById("hangman");
const ctx       = canvas.getContext("2d");
const wordEl    = document.getElementById("word");
const lettersEl = document.getElementById("letters");

const chatList  = document.getElementById("chatList");
const chatText  = document.getElementById("chatText");
const chatSend  = document.getElementById("chatSend");

const timerOpen = document.getElementById("timerOpen");
const timerConfig = document.getElementById("timerConfig");
const timerInput = document.getElementById("timerInput");
const timerConfirm = document.getElementById("timerConfirm");
const timerCancel  = document.getElementById("timerCancel");
const timerOff     = document.getElementById("timerOff");
const timerBar     = document.getElementById("timerBar");
const timerFill    = document.getElementById("timerFill");

const restartBtn = document.getElementById("restartBtn");
const newWordBtn = document.getElementById("newWordBtn");
const backBtn    = document.getElementById("backBtn");

const nameModal = document.getElementById("nameModal");
const nameModalInput = document.getElementById("nameModalInput");
const nameModalConfirm = document.getElementById("nameModalConfirm");

const params = new URLSearchParams(location.search);
const deepLinkGame = params.get("game"); // ‚úÖ only once!

/* ===========================================================
   State
=========================================================== */
const letters = [..."ABCDEFGHIJKLMNOPQRSTUVWXYZ√Ö√Ñ√ñ"];
let gameId = "";
let isHost = false;
let nickname = "";
let lang = localStorage.getItem("lang") || "sv";
let timerSeconds = 0;
let roundStartMs = 0;
let rafTimer = null;
let currentWrong = 0;
let lastUpdateKey = "";

/* ===========================================================
   i18n
=========================================================== */
const T = {
  sv:{
    name:"Ditt namn",
    enterWord:"Ange ett ord att spela med:",
    notFound:"Spelet hittades inte.",
    notYourTurn:"Inte din tur!",
    share:"Dela denna l√§nk:",
    loading:"Laddar spel‚Ä¶",
    yourTurn:"üéØ Din tur!",
    oppTurn:"‚è≥ Motst√•ndarens tur‚Ä¶",
    timeRanOut:"‚è∞ Tiden tog slut!",
    hostWon:"üéâ V√§rden vann!",
    guestWon:"üéâ G√§sten vann!",
    joinCodeMissing:"Ange spelkod.",
    confirmBack:"√Ñr du s√§ker p√• att du vill l√§mna och radera spelet?",
    waiting:"‚è≥ V√§ntar p√• spelare‚Ä¶",
    bothIn:"üéÆ B√•da spelare anslutna!",
    modalTitle:"V√§lj ett namn",
    modalDesc:"Du m√•ste ange ett namn f√∂r att g√• vidare.",
    modalPlaceholder:"Ditt namn"
  },
  en:{
    name:"Your name",
    enterWord:"Enter a word to start:",
    notFound:"Game not found.",
    notYourTurn:"Not your turn!",
    share:"Share this link:",
    loading:"Loading game‚Ä¶",
    yourTurn:"üéØ Your turn!",
    oppTurn:"‚è≥ Opponent's turn‚Ä¶",
    timeRanOut:"‚è∞ Time ran out!",
    hostWon:"üéâ Host won!",
    guestWon:"üéâ Guest won!",
    joinCodeMissing:"Enter a game code.",
    confirmBack:"Are you sure you want to leave and delete the game?",
    waiting:"‚è≥ Waiting for player‚Ä¶",
    bothIn:"üéÆ Both players connected!",
    modalTitle:"Choose a name",
    modalDesc:"You must enter a name to continue.",
    modalPlaceholder:"Your name"
  }
};
langSel.value = lang;
applyLang();

function applyLang(){
  nameLabel.textContent = T[lang].name;
  loadingText.textContent = T[lang].loading;
  chatText.placeholder = (lang==="sv") ? "Skriv ett meddelande..." : "Type a message...";
  nameModalInput.placeholder = T[lang].modalPlaceholder;
}

/* ===========================================================
   Utils
=========================================================== */
function escapeH(s){ return (s||"").replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]) ); }
function showLoading(b){ loading.classList.toggle("hidden", !b); }
function shareLink(){ return location.origin+location.pathname+"?game="+gameId; }

/* ===========================================================
   Nickname Required
=========================================================== */
function requireNickname(){
  let stored = (nameInput.value || localStorage.getItem("nickname") || "").trim();
  if(stored){
    nameInput.value = stored;
    localStorage.setItem("nickname", stored);
    return Promise.resolve(stored);
  }
  return new Promise(resolve=>{
    nameModal.style.display = "flex";
    nameModalInput.value = "";
    setTimeout(()=>nameModalInput.focus(), 50);
    function done(){
      let v = (nameModalInput.value||"").trim();
      if(!v) return;
      nameModal.style.display="none";
      nameInput.value = v;
      localStorage.setItem("nickname", v);
      resolve(v);
    }
    nameModalConfirm.onclick = done;
    nameModalInput.onkeydown = e=>{ if(e.key==="Enter") done(); };
  });
}

/* ===========================================================
   Presence UI
=========================================================== */
function updateLobby(players={}, presence={}){
  nameHost.textContent = players.host || "‚Äî";
  nameGuest.textContent = players.guest || T[lang].waiting;
  const hostOn = !!presence.host;
  const guestOn = !!presence.guest;
  dotHost.classList.toggle("online", hostOn);
  dotGuest.classList.toggle("online", guestOn);
  dotHost.classList.toggle("offline", !hostOn);
  dotGuest.classList.toggle("offline", !guestOn);
  lobbyMsg.textContent = (players.host && players.guest) ? T[lang].bothIn : T[lang].waiting;
}
function setupPresence(role){
  firebase.database().ref(".info/connected").on("value", snap=>{
    if(snap.val()){
      const r = db.ref(`games/${gameId}/presence/${role}`);
      r.set(true);
      r.onDisconnect().remove();
    }
  });
}

/* ===========================================================
   Canvas Drawing
=========================================================== */
function resizeCanvas(){
  const w = Math.min(560, Math.floor(gameMain.clientWidth*0.98));
  const h = Math.floor(w*1.25);
  canvas.width=w; canvas.height=h;
  drawAll(currentWrong);
}
window.addEventListener("resize", ()=>setTimeout(resizeCanvas,60));

function grad(){ const g=ctx.createLinearGradient(0,0,canvas.width,canvas.height); g.addColorStop(0,"#ec4899"); g.addColorStop(.5,"#a855f7"); g.addColorStop(1,"#ec4899"); return g; }
function drawAll(wrong){
  const cw=canvas.width,ch=canvas.height; const sX=cw/200,sY=ch/250; const lw=2*Math.min(sX,sY);
  ctx.clearRect(0,0,cw,ch); ctx.lineWidth=lw; ctx.strokeStyle=grad();
  ctx.beginPath();
  ctx.moveTo(10*sX,240*sY); ctx.lineTo(190*sX,240*sY);
  ctx.moveTo(50*sX,240*sY); ctx.lineTo(50*sX,20*sY); ctx.lineTo(130*sX,20*sY); ctx.lineTo(130*sX,50*sY); ctx.stroke();
  if(wrong>0){ctx.beginPath();ctx.arc(130*sX,70*sY,20*sX,0,Math.PI*2);ctx.stroke();}
  if(wrong>1){ctx.beginPath();ctx.moveTo(130*sX,90*sY);ctx.lineTo(130*sX,160*sY);ctx.stroke();}
  if(wrong>2){ctx.beginPath();ctx.moveTo(130*sX,110*sY);ctx.lineTo(100*sX,140*sY);ctx.stroke();}
  if(wrong>3){ctx.beginPath();ctx.moveTo(130*sX,110*sY);ctx.lineTo(160*sX,140*sY);ctx.stroke();}
  if(wrong>4){ctx.beginPath();ctx.moveTo(130*sX,160*sY);ctx.lineTo(110*sX,200*sY);ctx.stroke();}
  if(wrong>5){ctx.beginPath();ctx.moveTo(130*sX,160*sY);ctx.lineTo(150*sX,200*sY);ctx.stroke();}
}

/* ===========================================================
   Letters + Guess Logic
=========================================================== */
function setWordDisplay(word, guesses){ wordEl.textContent = word.split("").map(l => guesses.includes(l) ? l : "_").join(" "); }
function buildLetters(){
  lettersEl.innerHTML="";
  letters.forEach(ch=>{
    const btn=document.createElement("button");
    btn.textContent=ch;
    btn.onclick = async ()=>{
      const snap = await db.ref("games/"+gameId).get(); const d = snap.val();
      if(!d || d.over) return;
      const mine = isHost ? "host":"guest";
      if(d.turn!==mine) return alert(T[lang].notYourTurn);
      if(d.guesses.includes(ch)) return;
      let newGuesses=[...d.guesses,ch];
      let newWrong=d.wrong;
      let over=false, winner=null;
      const scores={...d.scores};

      const isWrong = !d.word.includes(ch);
      if(isWrong){
        newWrong++;
        canvas.classList.add("shake"); setTimeout(()=>canvas.classList.remove("shake"), 300);
      }
      const solved = d.word.split("").every(l=>newGuesses.includes(l));
      if(solved){ over=true; winner=mine; scores[mine]++; }
      else if(newWrong>=6){ over=true; const opp=mine==="host"?"guest":"host"; winner=opp; scores[opp]++; }

      await db.ref("games/"+gameId).update({
        guesses:newGuesses, wrong:newWrong, over, scores,
        winner, roundStartMs: firebase.database.ServerValue.TIMESTAMP
      });
    };
    lettersEl.appendChild(btn);
  });
}

/* ===========================================================
   Timer
=========================================================== */
function timerLoop(){
  stopTimerLoop();
  if(timerSeconds<=0 || !roundStartMs){ timerBar.style.display="none"; return; }
  timerBar.style.display="block";
  const tick = async ()=>{
    const now=Date.now();
    const remainMs=Math.max(0,(timerSeconds*1000)-Math.max(0,now-roundStartMs));
    const pct=Math.max(0,Math.min(1,remainMs/(timerSeconds*1000)));
    timerFill.style.width=(pct*100)+"%";
    if(remainMs<=3000) timerFill.classList.add("pulse"); else timerFill.classList.remove("pulse");
    if(remainMs<=0){
      const snap = await db.ref("games/"+gameId).get(); const d=snap.val();
      if(d && !d.over){
        const opp=d.turn==="host"?"guest":"host";
        const scores={...d.scores}; scores[opp]++;
        await db.ref("games/"+gameId).update({over:true,scores,winner:opp});
        systemMessage(T[lang].timeRanOut);
      }
      timerBar.style.display="none";
      return;
    }
    rafTimer=requestAnimationFrame(tick);
  };
  rafTimer=requestAnimationFrame(tick);
}
function stopTimerLoop(){ if(rafTimer) cancelAnimationFrame(rafTimer); rafTimer=null; }

/* ===========================================================
   Chat
=========================================================== */
function pushChat(msg){
  db.ref("games/"+gameId+"/chat").push({
    name:nickname, text:msg, ts:Date.now()
  });
}
chatSend.onclick = ()=>{
  const v=chatText.value.trim();
  if(!v)return;
  chatText.value=""; pushChat(v);
};
chatText.onkeydown = e=>{ if(e.key==="Enter") chatSend.click(); };

function addChat(obj){
  const wrap=document.createElement("div");
  wrap.className="chatMsg";
  wrap.innerHTML=`
    <div><b>${escapeH(obj.name||"??")}</b>: ${escapeH(obj.text||"")}</div>
    <div class="chatMeta">${new Date(obj.ts||Date.now()).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>`;
  chatList.appendChild(wrap);
  chatList.scrollTop=chatList.scrollHeight;
  setTimeout(()=>wrap.classList.add("fadeout"),15000);
  setTimeout(()=>wrap.remove(),16500);
}

function systemMessage(txt){ addChat({name:"System",text:txt,ts:Date.now()}); }

/* ===========================================================
   Turn UI
=========================================================== */
function setTurn(turn){
  const mine=isHost?"host":"guest";
  turnEl.textContent = (turn===mine) ? T[lang].yourTurn : T[lang].oppTurn;
  turnEl.classList.add("turn-flash");
  setTimeout(()=>turnEl.classList.remove("turn-flash"),50);
}

/* ===========================================================
   Navigation
=========================================================== */
function showGame(){
  startDiv.classList.add("hidden");
  gameDiv.classList.remove("hidden");
  resizeCanvas(); buildLetters();
}
backBtn.onclick = ()=>{
  if(!confirm(T[lang].confirmBack)) return;
  if(gameId) db.ref("games/"+gameId).remove();
  location.href = location.pathname;
};

/* ===========================================================
   Start Host / Join / Deep link
=========================================================== */
createBtn.onclick = async ()=>{
  nickname=(nameInput.value||"").trim();
  if(!nickname) nickname=await requireNickname();
  const word=(prompt(T[lang].enterWord)||"").toUpperCase();
  if(!/^[A-Z√Ö√Ñ√ñ]+$/.test(word)) return alert("Endast bokst√§ver A‚Äì√ñ!");
  const id="hangman-"+Math.random().toString(36).substr(2,5);
  await db.ref("games/"+id).set({
    word, guesses:[], wrong:0, turn:"guest", over:false,
    players:{host:nickname}, scores:{host:0,guest:0},
    settings:{timerSeconds:0}, presence:{}, roundStartMs:0
  });
  isHost=true; gameId=id;
  showGame(); setupPresence("host");
};

joinBtn.onclick = ()=> joinArea.classList.remove("hidden");

joinGo.onclick = async ()=>{
  const code=(joinCodeInput.value||"").trim();
  if(!code) return alert(T[lang].joinCodeMissing);
  nickname=(nameInput.value||"").trim();
  if(!nickname) nickname=await requireNickname();
  const id="hangman-"+code;
  showLoading(true);
  const snap=await db.ref("games/"+id).get();
  if(!snap.exists()){ showLoading(false); return alert(T[lang].notFound); }
  await db.ref("games/"+id+"/players").update({guest:nickname});
  isHost=false; gameId=id;
  showGame(); setupPresence("guest");
  showLoading(false);
};

/* ‚úÖ Direktl√§nk */
(async function directJoin(){
  if(!deepLinkGame) return;
  showGame();
  nickname=(nameInput.value||"").trim();
  if(!nickname) nickname=await requireNickname();
  showLoading(true);
  const snap=await db.ref("games/"+deepLinkGame).get();
  if(!snap.exists()){ showLoading(false); return backBtn.click(); }
  const d=snap.val();
  if(!d.players?.guest){
    await db.ref("games/"+deepLinkGame+"/players").update({guest:nickname});
  }
  isHost=false; gameId=deepLinkGame;
  setupPresence("guest");
  showLoading(false);
})();

/* ===========================================================
   Game listener
=========================================================== */
function listenGame(){
  db.ref("games/"+gameId+"/chat").limitToLast(50).on("child_added", s=> addChat(s.val()));

  db.ref("games/"+gameId).on("value", snap=>{
    const d=snap.val();
    if(!d) return;

    updateLobby(d.players, d.presence);

    timerSeconds=d.settings?.timerSeconds||0;
    roundStartMs=d.roundStartMs||0;
    if(d.over || timerSeconds<=0){
      stopTimerLoop();
      timerBar.style.display=(timerSeconds>0 && !d.over)?"block":"none";
    } else timerLoop();

    setWordDisplay(d.word,d.guesses||[]);
    currentWrong=d.wrong||0; drawAll(currentWrong);

    const used=new Set(d.guesses||[]);
    lettersEl.querySelectorAll("button").forEach(b=>{b.disabled=used.has(b.textContent)});

    scoreEl.textContent=`üßë ${d.scores.host} | üë§ ${d.scores.guest}`;
    setTurn(d.turn);

    if(d.over){
      restartBtn.classList.remove("hidden");
      newWordBtn.classList.remove("hidden");
      const msg = (d.winner==="host")?T[lang].hostWon:T[lang].guestWon;
      systemMessage(msg);
    } else {
      restartBtn.classList.add("hidden");
      newWordBtn.classList.add("hidden");
    }

    shareEl.innerHTML=`${T[lang].share} <a href="${shareLink()}" target="_blank">${shareLink()}</a>`;
  });
}

/* ===========================================================
   Restart + New Word
=========================================================== */
restartBtn.onclick = async ()=>{
  const snap=await db.ref("games/"+gameId).get(); const d=snap.val();
  if(!d)return;
  await db.ref("games/"+gameId).update({
    guesses:[], wrong:0, over:false, winner:null,
    roundStartMs: (timerSeconds>0?Date.now():0)
  });
};
newWordBtn.onclick = async ()=>{
  const snap=await db.ref("games/"+gameId).get(); const d=snap.val();
  if(!d.over) return alert("Rundan √§r inte slut √§n.");
  const nw=(prompt(T[lang].enterWord)||"").toUpperCase();
  if(!/^[A-Z√Ö√Ñ√ñ]+$/.test(nw)) return;
  const nextTurn = d.turn==="host"?"guest":"host";
  await db.ref("games/"+gameId).update({
    word:nw, guesses:[], wrong:0, over:false, winner:null,
    turn:nextTurn,
    roundStartMs:(timerSeconds>0?Date.now():0)
  });
};

/* ===========================================================
   Init
=========================================================== */
window.addEventListener("load", ()=>setTimeout(()=>{
  if(!deepLinkGame){
    startDiv.classList.remove("hidden");
    gameDiv.classList.add("hidden");
  }
  applyLang();
  listenGame();
  resizeCanvas();
}, 80));

langSel.onchange = ()=>{ lang=langSel.value; localStorage.setItem("lang",lang); applyLang(); };

</script>
</body>
</html>
