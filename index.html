<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>H√ÑNGA GUBBE</title>
  <meta name="theme-color" content="#0e0e11">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>
  <style>
    :root{
      /* Monochrome studio palette */
      --grad-a:#e5e7eb; /* silver */
      --grad-b:#9ca3af; /* gray-400 */
      --bg1:#0c0c0f;
      --bg2:#141418;
      --panel:rgba(255,255,255,.06);
      --panel-strong:rgba(255,255,255,.08);
      --text:#ffffff;
      --text-dim:#bdbdbd;
      --line:#2c2c33;
      --chip-bg:#1b1b20;
      --chip-line:#2e2e35;
      --gap:14px;
      --radius-xl:18px;
      --radius-lg:14px;
      --radius-md:12px;
      --shadow-1:0 8px 28px rgba(0,0,0,.45);
      --shadow-2:0 2px 10px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Poppins",sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 900px at 20% 20%, #1a1a1f 0%, rgba(26,26,31,0) 60%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      min-height:100dvh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
      overflow-x:hidden;
      -webkit-tap-highlight-color:transparent;
    }

    /* App shell */
    .shell{
      width:min(1200px,98vw);
      min-height:92dvh;
      display:flex; flex-direction:column;
      gap:var(--gap);
    }

    /* Top bar */
    .topbar{
      display:flex; align-items:center; gap:12px;
      justify-content:space-between;
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:var(--radius-xl);
      padding:10px 12px;
      backdrop-filter:blur(10px);
      box-shadow:var(--shadow-2);
    }
    .brand{
      display:flex; align-items:center; gap:10px;
    }
    .logo{
      width:34px; height:34px; border-radius:10px;
      background:linear-gradient(135deg,var(--grad-a),var(--grad-b));
      box-shadow:0 6px 20px rgba(200,200,200,.25);
    }
    .title{
      margin:0;
      font-weight:700;
      letter-spacing:.02em;
      font-size:clamp(1.1rem,2.2vw,1.4rem);
      background:linear-gradient(135deg,var(--grad-a),var(--grad-b));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    }
    .topbar-right{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    }

    /* Game code chip */
    #share{ color:var(--text-dim); font-size:.95rem; }
    .codeChip{
      display:inline-flex; align-items:center; gap:.4rem;
      padding:.28rem .6rem;
      border:1px solid var(--chip-line);
      border-radius:.7rem;
      background:var(--chip-bg);
      color:#fff;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      letter-spacing:.03em;
      box-shadow:var(--shadow-2);
      user-select:all;
    }

    /* Content card */
    .card{
      flex:1;
      background:var(--panel-strong);
      border:1px solid var(--line);
      border-radius:var(--radius-xl);
      backdrop-filter:blur(12px);
      box-shadow:var(--shadow-1);
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:var(--gap);
    }

    .hidden{display:none!important}
    .row{display:flex;gap:10px;align-items:center}
    .row>*{flex:1}

    /* Controls */
    input,select,button{
      font-family:inherit; font-size:1rem;
      border-radius:var(--radius-md);
      border:1px solid var(--line);
      padding:.8rem 1rem;
      background:#1a1a1f; color:#fff; width:100%;
    }
    select{background:#15151a}
    button{
      cursor:pointer; font-weight:700; color:#111; border:none;
      background:linear-gradient(135deg,var(--grad-a),var(--grad-b));
      box-shadow:0 8px 26px rgba(180,180,180,.25);
      transition:transform .15s ease, box-shadow .15s ease;
    }
    button:hover{transform:translateY(-2px)}
    button:disabled{opacity:.5;cursor:not-allowed}

    /* Start screen layout */
    .startGrid{display:grid;gap:12px;grid-template-columns:1fr}
    @media (min-width:720px){ .startGrid{grid-template-columns:1fr 1fr} }
    .full{grid-column:1 / -1}

    /* Lobby bar (inside card) */
    #lobbyBar{
      background:rgba(0,0,0,.12);
      border:1px solid var(--line);
      border-radius:var(--radius-lg);
      padding:8px;
      display:flex; gap:12px; justify-content:center; align-items:center; flex-wrap:wrap
    }
    .lobbyItem{display:flex;align-items:center;gap:8px}
    #lobbyMsg{color:var(--text-dim);font-size:.9rem}
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
    .online{background:#22c55e}.offline{background:#ef4444}

    /* Game grid */
    #gameMain{flex:1;display:flex;flex-direction:column;gap:14px}
    .gameGrid{display:grid;gap:14px;grid-template-columns:1fr;align-items:start}
    @media (min-width: 1024px){ .gameGrid{grid-template-columns: 1.3fr .7fr} }

    #scoreboard{text-align:center;font-weight:700;font-size:1.05rem;background:linear-gradient(135deg,var(--grad-a),var(--grad-b));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    #turnIndicator{text-align:center;font-weight:600;color:var(--text-dim)}

    .leftCol{display:flex;flex-direction:column;gap:12px}
    #hangman{
      width:100%;background:#0f0f13;border:1px solid var(--line);border-radius:var(--radius-lg);
      max-height:42dvh;min-height:260px
    }
    #word{text-align:center;letter-spacing:.25em;font-size:1.35rem;margin-top:4px}

    #letters{display:grid;gap:10px;margin:10px 0}
    #letters{grid-template-columns:repeat(12,1fr)}
    #letters button{font-weight:800}
    @media (hover:hover) and (pointer:fine){
      #letters button:hover:not(:disabled){
        box-shadow:0 0 12px rgba(220,220,220,.5), 0 0 18px rgba(180,180,180,.35);
        transform:translateY(-3px) scale(1.04)
      }
    }
    #letters button:disabled{filter:saturate(.7)}
    @media (max-width:959px){#letters{grid-template-columns:repeat(8,1fr)}}
    @media (max-width:600px){#letters{grid-template-columns:repeat(7,1fr);margin-bottom:40px}#hangman{max-height:38dvh}}
    @media (max-width:420px){#letters{grid-template-columns:repeat(6,1fr)}}
    @media (min-width:960px){
      #gameMain,#hangman,#letters,#chatWrap,#actions{max-width:1040px;margin:auto}
      #hangman{max-height:calc(70vh - 180px)}
    }

    /* Timer */
    #timerBar{width:100%;height:10px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden;display:none}
    #timerFill{height:100%;width:0;background:linear-gradient(90deg,var(--grad-a),var(--grad-b));transition:width .2s,filter .2s}
    .pulse{animation:pulse .8s ease-in-out infinite}
    @keyframes pulse{0%{filter:brightness(1)}50%{filter:brightness(1.5)}100%{filter:brightness(1)}}

    .shake{animation:shake .28s ease}
    @keyframes shake{
      0%{transform:translateX(0)}25%{transform:translateX(-4px)}50%{transform:translateX(4px)}75%{transform:translateX(-3px)}100%{transform:translateX(0)}
    }

    /* Right column */
    .rightCol{display:flex;flex-direction:column;gap:12px}
    #chatWrap{
      border:1px solid var(--line);
      border-radius:var(--radius-lg);
      background:rgba(255,255,255,.05);
      padding:10px;display:flex;flex-direction:column;gap:8px;min-height:280px
    }
    #chatList{flex:1;max-height:30dvh;overflow-y:auto;display:flex;flex-direction:column;gap:6px}
    .chatMsg{background:rgba(255,255,255,.06);border:1px solid #35353a;border-radius:10px;padding:6px;font-size:.95rem}
    .chatMeta{font-size:.75rem;color:var(--text-dim);margin-top:2px}
    .fadeout{opacity:0;transition:opacity .6s}
    #actions{display:flex;gap:8px;justify-content:center;margin-top:2px;flex-wrap:wrap}

  </style>
</head>
<body>
  <div class="shell">
    <!-- Top bar (available everywhere) -->
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1 class="title" id="appTitle">H√ÑNGA GUBBE</h1>
      </div>
      <div class="topbar-right">
        <div id="share"></div>
        <!-- Live language switch (works pre-game and in-game) -->
        <label class="hidden" for="langGlobal" id="langTopLabel">Language</label>
        <select id="langGlobal" aria-labelledby="langTopLabel">
          <option value="sv">Svenska</option>
          <option value="en">English</option>
        </select>
        <button id="backBtnTop" class="hidden">‚¨ÖÔ∏è Back</button>
      </div>
    </div>

    <!-- Start screen -->
    <div id="start" class="card">
      <div class="startGrid">
        <div>
          <label for="playerName" id="nameLabel">Ditt namn</label>
          <input id="playerName" maxlength="24"/>
        </div>
        <div class="hidden">
          <!-- (kept for accessibility; global switcher controls language now) -->
          <label for="lang" id="langLabel">Spr√•k / Language</label>
          <select id="lang">
            <option value="sv">Svenska</option>
            <option value="en">English</option>
          </select>
        </div>

        <div class="row full">
          <button id="createBtn">üÜï Skapa spel</button>
          <button id="joinBtn">üîó G√• med i spel</button>
        </div>

        <div id="joinArea" class="row hidden full">
          <input id="joinCode" placeholder="Kod (t.ex. ab123)" maxlength="10"/>
          <button id="joinGo">G√• med</button>
        </div>
      </div>
    </div>

    <!-- Game -->
    <div id="game" class="card hidden">
      <div id="lobbyBar">
        <div class="lobbyItem"><span id="dotHost" class="dot offline"></span>üëë <span id="nameHost">‚Äî</span></div>
        <div class="lobbyItem"><span id="dotGuest" class="dot offline"></span>üë§ <span id="nameGuest">‚è≥ V√§ntar‚Ä¶</span></div>
        <div id="lobbyMsg" class="lobbyItem">‚Äî</div>
      </div>

      <div id="gameMain">
        <div id="scoreboard">üßë 0 | üë§ 0</div>
        <div id="turnIndicator">‚è≥ V√§ntar p√• tur‚Ä¶</div>

        <div class="gameGrid">
          <!-- Left -->
          <div class="leftCol">
            <canvas id="hangman"></canvas>
            <div id="word">_</div>

            <div class="row" id="timerControlsRow" style="justify-content:center;flex-wrap:wrap">
              <button id="timerOpen" class="hidden" style="max-width:220px">‚è± St√§ll in timer</button>
              <div id="timerConfig" class="row hidden" style="max-width:520px;width:100%">
                <input id="timerInput" type="number" min="0" max="100" value="0"/>
                <button id="timerConfirm">‚úÖ</button>
                <button id="timerCancel">‚úñ</button>
                <button id="timerOff">üïí Av</button>
              </div>
            </div>

            <div id="timerBar"><div id="timerFill"></div></div>
            <div id="letters"></div>
          </div>

          <!-- Right -->
          <div class="rightCol">
            <div id="chatWrap">
              <div id="chatList"></div>
              <div class="row">
                <input id="chatText" placeholder="Skriv ett meddelande..." maxlength="200"/>
                <button id="chatSend">Skicka</button>
              </div>
            </div>
            <div id="actions">
              <button id="newWordBtn" class="hidden">‚úçÔ∏è V√§lj nytt ord</button>
              <button id="backBtn">‚¨ÖÔ∏è Tillbaka</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Name modal -->
    <div id="nameModal" style="position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:9999;padding:16px">
      <div style="width:min(440px,92vw);background:rgba(20,20,24,.97);border:1px solid #333;border-radius:14px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.6)">
        <h2 id="nameModalTitle" style="margin:0 0 8px;font-size:1.1rem">V√§lj ett namn</h2>
        <p id="nameModalDesc" style="margin:0 0 10px;color:#bdbdbd;font-size:.95rem">Du m√•ste ange ett namn f√∂r att g√• vidare.</p>
        <input id="nameModalInput" maxlength="24" style="width:100%;font-family:inherit;font-size:1rem;border-radius:12px;border:1px solid #333;padding:.8rem 1rem;background:#222;color:#fff"/>
        <div class="row" style="margin-top:10px"><button id="nameModalConfirm">OK</button></div>
      </div>
    </div>
  </div>

  <script>
    /* ---------- Firebase ---------- */
    const firebaseConfig={
      apiKey:"AIzaSyAN9URR47HIBwIuBP3kSu5Rv_Ys0ef72-Q",
      authDomain:"hangman-6a99e.firebaseapp.com",
      databaseURL:"https://hangman-6a99e-default-rtdb.europe-west1.firebasedatabase.app",
      projectId:"hangman-6a99e",
      storageBucket:"hangman-6a99e.firebasestorage.app",
      messagingSenderId:"992689481911",
      appId:"1:992689481911:web:6461e931ba4d96879ec532"
    };
    firebase.initializeApp(firebaseConfig);
    const db=firebase.database();

    /* ---------- DOM ---------- */
    const startDiv=document.getElementById("start"),
          gameDiv=document.getElementById("game"),
          gameMain=document.getElementById("gameMain"),
          appTitle=document.getElementById("appTitle"),
          langGlobal=document.getElementById("langGlobal"),
          backBtnTop=document.getElementById("backBtnTop"),
          shareEl=document.getElementById("share"),

          nameInput=document.getElementById("playerName"),
          nameLabel=document.getElementById("nameLabel"),
          createBtn=document.getElementById("createBtn"),
          joinBtn=document.getElementById("joinBtn"),
          joinArea=document.getElementById("joinArea"),
          joinCodeInput=document.getElementById("joinCode"),
          joinGo=document.getElementById("joinGo"),

          nameHost=document.getElementById("nameHost"),
          nameGuest=document.getElementById("nameGuest"),
          dotHost=document.getElementById("dotHost"),
          dotGuest=document.getElementById("dotGuest"),
          lobbyMsg=document.getElementById("lobbyMsg"),

          scoreEl=document.getElementById("scoreboard"),
          turnEl=document.getElementById("turnIndicator"),
          canvas=document.getElementById("hangman"),
          ctx=canvas.getContext("2d"),
          wordEl=document.getElementById("word"),
          lettersEl=document.getElementById("letters"),
          chatList=document.getElementById("chatList"),
          chatText=document.getElementById("chatText"),
          chatSend=document.getElementById("chatSend"),
          timerOpen=document.getElementById("timerOpen"),
          timerConfig=document.getElementById("timerConfig"),
          timerInput=document.getElementById("timerInput"),
          timerConfirm=document.getElementById("timerConfirm"),
          timerCancel=document.getElementById("timerCancel"),
          timerOff=document.getElementById("timerOff"),
          timerBar=document.getElementById("timerBar"),
          timerFill=document.getElementById("timerFill"),
          newWordBtn=document.getElementById("newWordBtn"),
          backBtn=document.getElementById("backBtn"),
          nameModal=document.getElementById("nameModal"),
          nameModalInput=document.getElementById("nameModalInput"),
          nameModalConfirm=document.getElementById("nameModalConfirm");

    /* ---------- State ---------- */
    const params=new URLSearchParams(location.search),deepLinkGame=params.get("game");
    const letters=[..."ABCDEFGHIJKLMNOPQRSTUVWXYZ√Ö√Ñ√ñ"];
    let gameId="",isHost=!1,nickname="",lang=localStorage.getItem("lang")||"sv",timerSeconds=0,roundStartMs=0,rafTimer=null,currentWrong=0,lastUpdateKey="";
    const T={
      sv:{
        appTitle:"H√ÑNGA GUBBE",
        nameLabel:"Ditt namn",
        enterWord:"Ange ett ord att spela med:",
        notFound:"Spelet hittades inte.",
        notYourTurn:"Inte din tur!",
        share:"Spelkod:",
        loading:"Laddar spel‚Ä¶",
        yourTurn:"üéØ Din tur!",
        oppTurn:"‚è≥ Motst√•ndarens tur‚Ä¶",
        timeRanOut:"‚è∞ Tiden tog slut!",
        hostWon:"üéâ V√§rden vann!",
        guestWon:"üéâ G√§sten vann!",
        joinCodeMissing:"Ange spelkod.",
        confirmBack:"√Ñr du s√§ker p√• att du vill l√§mna och radera spelet?",
        waiting:"‚è≥ V√§ntar p√• spelare‚Ä¶",
        bothIn:"üéÆ B√•da spelare anslutna!",
        chooseWordCta:"‚úçÔ∏è V√§lj nytt ord",
        back:"‚¨ÖÔ∏è Tillbaka",
        create:"üÜï Skapa spel",
        join:"üîó G√• med i spel",
        joinGo:"G√• med",
        joinPlaceholder:"Kod (t.ex. ab123)",
        chatPlaceholder:"Skriv ett meddelande...",
        chatSend:"Skicka",
        timerOpen:"‚è± St√§ll in timer",
        timerOff:"üïí Av",
        modalTitle:"V√§lj ett namn",
        modalDesc:"Du m√•ste ange ett namn f√∂r att g√• vidare.",
        modalPlaceholder:"Ditt namn",
        chooserOnly:"Bara ordgivaren kan starta n√§sta runda.",
        roundNotOver:"Rundan √§r inte slut √§n."
      },
      en:{
        appTitle:"HANGMAN",
        nameLabel:"Your name",
        enterWord:"Enter a word to start:",
        notFound:"Game not found.",
        notYourTurn:"Not your turn!",
        share:"Game code:",
        loading:"Loading game‚Ä¶",
        yourTurn:"üéØ Your turn!",
        oppTurn:"‚è≥ Opponent's turn‚Ä¶",
        timeRanOut:"‚è∞ Time ran out!",
        hostWon:"üéâ Host won!",
        guestWon:"üéâ Guest won!",
        joinCodeMissing:"Enter a game code.",
        confirmBack:"Are you sure you want to leave and delete the game?",
        waiting:"‚è≥ Waiting for player‚Ä¶",
        bothIn:"üéÆ Both players connected!",
        chooseWordCta:"‚úçÔ∏è Pick new word",
        back:"‚¨ÖÔ∏è Back",
        create:"üÜï Create game",
        join:"üîó Join game",
        joinGo:"Join",
        joinPlaceholder:"Code (e.g. ab123)",
        chatPlaceholder:"Type a message...",
        chatSend:"Send",
        timerOpen:"‚è± Set timer",
        timerOff:"üïí Off",
        modalTitle:"Choose a name",
        modalDesc:"You must enter a name to continue.",
        modalPlaceholder:"Your name",
        chooserOnly:"Only the word chooser can start the next round.",
        roundNotOver:"Round not over."
      }
    };

    /* ---------- i18n ---------- */
    function applyLang(){
      const L=T[lang];
      document.documentElement.lang = (lang==='sv'?'sv':'en');
      appTitle.textContent = L.appTitle;

      // Start screen
      nameLabel.textContent = L.nameLabel;
      createBtn.textContent = L.create;
      joinBtn.textContent = L.join;
      joinGo.textContent = L.joinGo;
      joinCodeInput.placeholder = L.joinPlaceholder;

      // Game UI
      newWordBtn.textContent = L.chooseWordCta;
      backBtn.textContent = L.back;
      chatText.placeholder = L.chatPlaceholder;
      chatSend.textContent = L.chatSend;
      document.getElementById("timerOpen").textContent = L.timerOpen;
      document.getElementById("timerOff").textContent = L.timerOff;

      // Name modal
      document.getElementById("nameModalTitle").textContent = L.modalTitle;
      document.getElementById("nameModalDesc").textContent = L.modalDesc;
      nameModalInput.placeholder = L.modalPlaceholder;

      // Topbar back label based on language/state
      backBtnTop.textContent = (lang==='sv') ? "‚¨ÖÔ∏è Tillbaka" : "‚¨ÖÔ∏è Back";

      // Refresh code chip text
      updateShareText();
      updateLobbyTextWaiting();
      updateTurnLabel(lastTurnCached);
    }
    function updateLobbyTextWaiting(){
      const hasGuest = nameGuest.dataset.hasGuest==="1";
      if(!hasGuest) nameGuest.textContent = T[lang].waiting;
    }

    langGlobal.value = lang;
    langGlobal.onchange = ()=>{
      lang = langGlobal.value;
      localStorage.setItem("lang", lang);
      applyLang();
    };

    // Keep hidden legacy #lang (if any) in sync for safety
    const hiddenStartLang = document.getElementById("lang");
    if(hiddenStartLang){ hiddenStartLang.value = lang; hiddenStartLang.onchange = ()=>{ langGlobal.value = hiddenStartLang.value; langGlobal.onchange() } }

    /* ---------- Helpers ---------- */
    const escapeH=s=>(s||"").replace(/[&<>\"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m]));
    const gameCode=()=> (gameId||"").replace(/^hangman-/,"");

    function requireNickname(){
      let stored=(nameInput.value||localStorage.getItem("nickname")||"").trim();
      if(stored){ nameInput.value=stored; localStorage.setItem("nickname",stored); return Promise.resolve(stored) }
      return new Promise(res=>{
        nameModal.style.display="flex"; nameModalInput.value="";
        setTimeout(()=>nameModalInput.focus(),40);
        function done(){
          let v=(nameModalInput.value||"").trim(); if(!v)return;
          nameModal.style.display="none"; nameInput.value=v; localStorage.setItem("nickname",v); res(v)
        }
        nameModalConfirm.onclick=done; nameModalInput.onkeydown=e=>{"Enter"===e.key&&done()}
      })
    }

    function updateLobby(p={},pr={}){
      nameHost.textContent=p.host||"‚Äî";
      const hasGuest = !!p.guest;
      nameGuest.textContent=hasGuest ? p.guest : T[lang].waiting;
      nameGuest.dataset.hasGuest = hasGuest ? "1" : "0";
      const h=!!pr.host,g=!!pr.guest;
      dotHost.classList.toggle("online",h); dotHost.classList.toggle("offline",!h);
      dotGuest.classList.toggle("online",g); dotGuest.classList.toggle("offline",!g);
      lobbyMsg.textContent=(p.host&&p.guest)?T[lang].bothIn:T[lang].waiting
    }
    function setupPresence(role){
      firebase.database().ref(".info/connected").on("value",s=>{
        if(s.val()){
          const r=db.ref(`games/${gameId}/presence/${role}`); r.set(!0); r.onDisconnect().remove()
        }
      })
    }

    /* ---------- Canvas ---------- */
    function resizeCanvas(){
      const w=Math.min(900,Math.floor(gameMain.clientWidth));
      const h=Math.floor(Math.min(w*1.25,(window.innerHeight*0.7)-180));
      canvas.width=Math.max(260,Math.min(w,900));
      canvas.height=Math.max(260,h);
      drawAll(currentWrong);
      canvas.style.maxWidth="100%"; canvas.style.height="auto"
    }
    window.addEventListener("resize",()=>setTimeout(resizeCanvas,60));

    const grad=()=>{
      const g=ctx.createLinearGradient(0,0,canvas.width,canvas.height);
      const styles=getComputedStyle(document.documentElement);
      g.addColorStop(0,styles.getPropertyValue('--grad-a').trim());
      g.addColorStop(.5,styles.getPropertyValue('--grad-b').trim());
      g.addColorStop(1,styles.getPropertyValue('--grad-a').trim());
      return g
    };
    function drawAll(w){
      const cw=canvas.width,ch=canvas.height,sX=cw/200,sY=ch/250,lw=2*Math.min(sX,sY);
      ctx.clearRect(0,0,cw,ch); ctx.lineWidth=lw; ctx.strokeStyle=grad();
      ctx.beginPath(); // gallows
      ctx.moveTo(10*sX,240*sY);ctx.lineTo(190*sX,240*sY);
      ctx.moveTo(50*sX,240*sY);ctx.lineTo(50*sX,20*sY);ctx.lineTo(130*sX,20*sY);ctx.lineTo(130*sX,50*sY);
      ctx.stroke();
      if(w>0){ctx.beginPath();ctx.arc(130*sX,70*sY,20*sX,0,Math.PI*2);ctx.stroke()}
      if(w>1){ctx.beginPath();ctx.moveTo(130*sX,90*sY);ctx.lineTo(130*sX,160*sY);ctx.stroke()}
      if(w>2){ctx.beginPath();ctx.moveTo(130*sX,110*sY);ctx.lineTo(100*sX,140*sY);ctx.stroke()}
      if(w>3){ctx.beginPath();ctx.moveTo(130*sX,110*sY);ctx.lineTo(160*sX,140*sY);ctx.stroke()}
      if(w>4){ctx.beginPath();ctx.moveTo(130*sX,160*sY);ctx.lineTo(110*sX,200*sY);ctx.stroke()}
      if(w>5){ctx.beginPath();ctx.moveTo(130*sX,160*sY);ctx.lineTo(150*sX,200*sY);ctx.stroke()}
    }
    function setWordDisplay(word,guesses){
      wordEl.textContent=word.split("").map(l=>guesses.includes(l)?l:"_").join(" ")
    }

    /* ---------- Letters ---------- */
    function buildLetters(){
      lettersEl.innerHTML="";
      letters.forEach(ch=>{
        const b=document.createElement("button");
        b.textContent=ch;
        b.dataset.letter=ch;
        b.onclick=onGuess;
        lettersEl.appendChild(b)
      })
    }

    async function onGuess(){
      const ch=this.textContent;
      const snap=await db.ref("games/"+gameId).get(),d=snap.val();
      if(!d || d.over || d.awaitingWordBy){ return }
      const mine=isHost?"host":"guest";
      if(d.turn!==mine){ return }
      if((d.guesses||[]).includes(ch))return;

      let newGuesses=[...(d.guesses||[]),ch],newWrong=d.wrong||0,over=!1,winner=null;
      const scores={...(d.scores||{host:0,guest:0})};
      const isWrong=!d.word.includes(ch);
      if(isWrong){
        newWrong++; canvas.classList.add("shake"); setTimeout(()=>canvas.classList.remove("shake"),300)
      }
      const solved=d.word.split("").every(l=>newGuesses.includes(l));
      if(solved){ over=!0; winner=mine; scores[mine]=(scores[mine]||0)+1 }
      else if(newWrong>=6){ over=!0; const opp=mine==="host"?"guest":"host"; winner=opp; scores[opp]=(scores[opp]||0)+1 }

      const patch={guesses:newGuesses,wrong:newWrong,over,scores,winner,roundStartMs:firebase.database.ServerValue.TIMESTAMP};
      if(over){ patch.awaitingWordBy = mine } // current guesser chooses next
      await db.ref("games/"+gameId).update(patch)
    }

    /* ---------- Timer ---------- */
    function stopTimerLoop(){ if(rafTimer)cancelAnimationFrame(rafTimer); rafTimer=null }
    function timerLoop(){
      stopTimerLoop();
      if(timerSeconds<=0||!roundStartMs){ timerBar.style.display="none"; return }
      timerBar.style.display="block";
      const tick=async()=>{
        const now=Date.now(),remainMs=Math.max(0,timerSeconds*1000-Math.max(0,now-roundStartMs)),pct=Math.max(0,Math.min(1,remainMs/(timerSeconds*1000)));
        timerFill.style.width=pct*100+"%"; timerFill.classList.toggle("pulse",remainMs<=3000);
        if(remainMs<=0){
          const snap=await db.ref("games/"+gameId).get(),d=snap.val();
          if(d && !d.over){
            const opp=("host"===d.turn)?"guest":"host",scores={...(d.scores||{})};
            scores[opp]=(scores[opp]||0)+1;
            await db.ref("games/"+gameId).update({over:!0,scores,winner:opp,awaitingWordBy:d.turn});
            addChat({name:"System",text:(lang==="sv")?T.sv.timeRanOut:T.en.timeRanOut,ts:Date.now()})
          }
          timerBar.style.display="none"; return
        }
        rafTimer=requestAnimationFrame(tick)
      };
      rafTimer=requestAnimationFrame(tick)
    }

    /* ---------- Chat ---------- */
    function pushChat(m){ db.ref("games/"+gameId+"/chat").push({name:nickname,text:m,ts:Date.now()}) }
    chatSend.onclick=()=>{ const v=chatText.value.trim(); if(!v)return; chatText.value=""; pushChat(v) };
    chatText.onkeydown=e=>{"Enter"===e.key&&chatSend.click()};
    function addChat(o){
      const wrap=document.createElement("div");
      wrap.className="chatMsg";
      wrap.innerHTML=`<div><b>${escapeH(o.name||"??")}</b>: ${escapeH(o.text||"")}</div><div class="chatMeta">${new Date(o.ts||Date.now()).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div>`;
      chatList.appendChild(wrap); chatList.scrollTop=chatList.scrollHeight;
      setTimeout(()=>wrap.classList.add("fadeout"),15000); setTimeout(()=>wrap.remove(),16500)
    }

    let lastTurnCached=null;
    function updateTurnLabel(turn){
      if(!turn) return;
      const mine=isHost?"host":"guest";
      turnEl.textContent=(turn===mine)?((lang==="sv")?T.sv.yourTurn:T.en.yourTurn):((lang==="sv")?T.sv.oppTurn:T.en.oppTurn);
      turnEl.style.opacity=".3"; setTimeout(()=>turnEl.style.opacity="1",120)
    }

    /* ---------- UI enable/disable ---------- */
    function setLettersEnabled(enabled){
      lettersEl.querySelectorAll("button").forEach(b=>b.disabled=!enabled || b.dataset.used==="1")
    }
    function setAllInteractiveDisabled(disabled){
      setLettersEnabled(!disabled);
      [timerOpen,timerConfirm,timerCancel,timerOff,timerInput].forEach(el=>{ if(el) el.disabled=disabled })
    }

    function updateShareText(){
      const L=T[lang]; const code=gameCode()||"‚Äî";
      shareEl.innerHTML=`${L.share} <span class="codeChip">${code}</span>`;
      // Back button in topbar is visible only when inside a game
      backBtnTop.classList.toggle("hidden", !gameId);
    }

    function showGame(){
      startDiv.classList.add("hidden"); gameDiv.classList.remove("hidden");
      resizeCanvas(); buildLetters(); updateShareText();
    }

    /* ---------- Navigation ---------- */
    function confirmBack(){
      return confirm(T[lang].confirmBack);
    }
    function leaveGame(){
      if(gameId) db.ref("games/"+gameId).remove();
      location.href=location.pathname;
    }
    backBtn.onclick=()=>{ if(confirmBack()) leaveGame() };
    backBtnTop.onclick=()=>{ if(confirmBack()) leaveGame() };

    /* ---------- Create / Join ---------- */
    createBtn.onclick=async()=>{
      nickname=(nameInput.value||"").trim(); if(!nickname)nickname=await requireNickname();
      const word=(prompt(T[lang].enterWord)||"").toUpperCase();
      if(!/^[A-Z√Ö√Ñ√ñ]+$/.test(word))return alert("Endast bokst√§ver A‚Äì√ñ!");
      const id="hangman-"+Math.random().toString(36).substr(2,5);
      await db.ref("games/"+id).set({
        word,guesses:[],wrong:0,turn:"guest",over:!1,
        players:{host:nickname},scores:{host:0,guest:0},
        settings:{timerSeconds:0},presence:{},roundStartMs:0,
        awaitingWordBy:null
      });
      isHost=!0; gameId=id; showGame(); setupPresence("host"); listenGame()
    };

    joinBtn.onclick=()=>joinArea.classList.remove("hidden");

    joinGo.onclick=async()=>{
      const code=(joinCodeInput.value||"").trim();
      if(!code) return alert(T[lang].joinCodeMissing);
      nickname=(nameInput.value||"").trim(); if(!nickname)nickname=await requireNickname();
      const id="hangman-"+code;
      const snap=await db.ref("games/"+id).get();
      if(!snap.exists())return alert(T[lang].notFound);
      await db.ref("games/"+id+"/players").update({guest:nickname});
      isHost=!1; gameId=id; showGame(); setupPresence("guest"); listenGame()
    };

    (async function directJoin(){
      if(!deepLinkGame)return;
      showGame(); nickname=(nameInput.value||"").trim(); if(!nickname)nickname=await requireNickname();
      const snap=await db.ref("games/"+deepLinkGame).get();
      if(!snap.exists())return leaveGame();
      const d=snap.val();
      if(!d.players?.guest){ await db.ref("games/"+deepLinkGame+"/players").update({guest:nickname}) }
      isHost=!1; gameId=deepLinkGame; setupPresence("guest"); listenGame()
    })();

    /* ---------- Game listener ---------- */
    function listenGame(){
      if(!gameId)return;

      db.ref("games/"+gameId+"/chat").limitToLast(50).on("child_added",s=>addChat(s.val()));

      db.ref("games/"+gameId").on("value",snap=>{
        const d=snap.val(); if(!d)return;

        updateLobby(d.players||{},d.presence||{});

        const key=JSON.stringify([d.guesses,d.wrong,d.over,d.turn,d.scores,d.settings,d.roundStartMs,d.winner,d.awaitingWordBy]);
        if(key===lastUpdateKey) return; lastUpdateKey=key;

        timerSeconds=d.settings?.timerSeconds||0; roundStartMs=d.roundStartMs||0;
        (d.over||timerSeconds<=0)?(stopTimerLoop(),timerBar.style.display=(timerSeconds>0&&!d.over)?"block":"none"):timerLoop();

        setWordDisplay(d.word,d.guesses||[]); currentWrong=d.wrong||0; drawAll(currentWrong);

        // used letters
        const used=new Set(d.guesses||[]);
        lettersEl.querySelectorAll("button").forEach(b=>{
          const usedNow=used.has(b.textContent);
          b.disabled = usedNow; b.dataset.used=usedNow?"1":"0";
        });

        // scores & turn
        scoreEl.textContent=`üßë ${d.scores?.host||0} | üë§ ${d.scores?.guest||0}`;
        lastTurnCached = d.turn;
        updateTurnLabel(d.turn);
        updateShareText();

        /* ----- Post-round lock + chooser control ----- */
        const mine=isHost?"host":"guest";
        const chooser = d.awaitingWordBy || null;
        const isChooser = chooser && chooser===mine;

        // Enable letters only if: not over, not awaiting word, and it's my turn
        const myTurnActive = (!d.over && !chooser && d.turn===mine);
        setAllInteractiveDisabled(!myTurnActive);

        // If awaiting a word: only chooser sees enabled button; others locked
        if(chooser){
          newWordBtn.classList.remove("hidden");
          newWordBtn.disabled = !isChooser;
          if(!isChooser){
            setAllInteractiveDisabled(true);
            addChat({name:"System", text:(lang==="sv")?T.sv.chooserOnly:T.en.chooserOnly, ts:Date.now()});
          }
        }else{
          newWordBtn.classList.add("hidden");
        }

        // On round end, freeze letters
        if(d.over){
          setAllInteractiveDisabled(true);
          if(d.winner){
            addChat({name:"System",
              text:(d.winner==="host")?((lang==="sv")?T.sv.hostWon:T.en.hostWon):((lang==="sv")?T.sv.guestWon:T.en.guestWon),
              ts:Date.now()
            })
          }
        }
      })
    }

    /* ---------- New word (chooser only) ---------- */
    newWordBtn.onclick=async()=>{
      const s=await db.ref("games/"+gameId).get(),d=s.val(); if(!d) return;
      if(!d.over && !d.awaitingWordBy) return alert((lang==="sv")?T.sv.roundNotOver:T.en.roundNotOver);
      const mine=isHost?"host":"guest";
      if(d.awaitingWordBy!==mine) return alert((lang==="sv")?T.sv.chooserOnly:T.en.chooserOnly);

      const nw=(prompt(T[lang].enterWord)||"").toUpperCase();
      if(!/^[A-Z√Ö√Ñ√ñ]+$/.test(nw)) return;

      const nextTurn = (mine==="host")?"guest":"host";
      await db.ref("games/"+gameId).update({
        word:nw,guesses:[],wrong:0,over:!1,winner:null,
        turn:nextTurn, roundStartMs:(timerSeconds>0?Date.now():0),
        awaitingWordBy:null
      });
      newWordBtn.classList.add("hidden");
    };

    /* ---------- Timer controls ---------- */
    timerOpen.onclick=()=>{timerConfig.classList.remove("hidden");timerOpen.classList.add("hidden")};
    timerCancel.onclick=()=>{timerConfig.classList.add("hidden");timerOpen.classList.remove("hidden")};
    timerConfirm.onclick=async()=>{
      const v=Math.max(0,Math.min(100,Number(timerInput.value||0)));
      await db.ref("games/"+gameId+"/settings").update({timerSeconds:v});
      await db.ref("games/"+gameId).update({roundStartMs:firebase.database.ServerValue.TIMESTAMP});
      timerConfig.classList.add("hidden")
    };
    timerOff.onclick=async()=>{
      await db.ref("games/"+gameId+"/settings").update({timerSeconds:0});
      await db.ref("games/"+gameId).update({roundStartMs:0});
      timerConfig.classList.add("hidden");timerOpen.classList.remove("hidden")
    };

    /* ---------- Load ---------- */
    window.addEventListener("load",()=>{
      langGlobal.value = lang;
      applyLang();

      if(!deepLinkGame){
        startDiv.classList.remove("hidden");
        gameDiv.classList.add("hidden");
      }
      updateShareText();
      resizeCanvas()
    });
  </script>
</body>
</html>
