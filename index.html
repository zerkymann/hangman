<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>H√ÑNGA GUBBE</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
        rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>
  <style>
    :root{
      --bg1:#0d0d0f; --bg2:#1a1a1f;
      --panel:rgba(255,255,255,0.05);
      --text:#fff; --text-dim:#bdbdbd;
      --grad-a:#a855f7; --grad-b:#ec4899; /* interactive gradient */
    }

    /* Static background + particle canvas behind everything */
    body{
      font-family:"Poppins",sans-serif;
      background: radial-gradient(1200px 800px at 20% 10%, #17171b, #0f0f12 40%, #0b0b0d 70%),
                  linear-gradient(160deg, var(--bg1), var(--bg2));
      color:var(--text);
      display:flex; align-items:center; justify-content:center;
      height:100dvh; margin:0; overflow:hidden; padding:0 10px;
    }
    #bgParticles{
      position:fixed; inset:0; z-index:0; pointer-events:none;
    }

    /* Card */
    #gameContainer{
      position:relative; z-index:1;
      background:var(--panel); backdrop-filter:blur(12px);
      width:100%; max-width:920px; height:95%; max-height:95dvh;
      border-radius:20px; box-shadow:0 0 25px rgba(0,0,0,.6);
      padding:16px; display:grid; grid-template-columns: 1.2fr .8fr; gap:14px; overflow:hidden;
    }
    @media (max-width: 820px){
      #gameContainer{ display:flex; flex-direction:column; }
    }

    h1{
      grid-column:1 / -1;
      margin:0; text-align:center; font-weight:600;
      font-size:clamp(1.5rem,5vw,2rem);
      color:transparent; background:linear-gradient(135deg,var(--grad-a),var(--grad-b));
      -webkit-background-clip:text; background-clip:text;
      text-shadow:0 0 18px rgba(236,72,153,.18);
    }

    /* Left column: game */
    #leftCol{display:flex; flex-direction:column; gap:10px; min-height:0;}
    /* Right column: chat / lobby */
    #rightCol{display:flex; flex-direction:column; gap:10px; min-height:0;}

    /* Scoreboard */
    #scoreboard{
      display:flex; justify-content:space-between; align-items:center;
      gap:10px; padding:8px 12px; border-radius:12px;
      background:rgba(255,255,255,0.08); font-weight:600;
      font-size:clamp(.85rem,3.3vw,1rem);
      color:transparent; background-image:linear-gradient(135deg,var(--grad-a),var(--grad-b));
      -webkit-background-clip:text; background-clip:text;
    }
    #scoreboard .score{display:inline-block; transition:transform .25s ease}
    #youAre{margin-top:4px; font-size:.9rem; opacity:.85; color:var(--text-dim)}
    .totals{font-size:.85rem; color:var(--text-dim); margin-top:2px}

    /* Timer config (host only) */
    #timerConfig{
      display:none; align-items:center; justify-content:flex-start; gap:8px;
      font-weight:600; color:var(--text-dim);
    }
    #timerInput{
      width:76px; padding:.5rem .6rem; border-radius:10px; border:1px solid #333;
      background:#222; color:#fff; font-weight:700; text-align:center;
    }
    .btn{
      color:#111; cursor:pointer; border:none; border-radius:10px; padding:.6rem .9rem; font-weight:700;
      background:linear-gradient(135deg,var(--grad-a),var(--grad-b));
      box-shadow:0 6px 18px rgba(168,85,247,.25);
    }
    .btn:hover{ transform: translateY(-2px); }

    /* Game area */
    #hangZone{display:flex; flex-direction:column; align-items:center; gap:10px; flex:1; min-height:0;}
    #hangman{
      width:min(90%,360px); aspect-ratio:200/250;
      background:#111; border:1px solid #333; border-radius:10px;
      box-shadow:inset 0 0 15px rgba(0,0,0,.35); display:block;
    }

    /* Timer bar */
    #timerBar{
      width:100%; max-width:520px; height:8px; border-radius:999px;
      background:rgba(255,255,255,.08); overflow:hidden; display:none;
    }
    #timerFill{
      height:100%; width:0%;
      background:linear-gradient(135deg,var(--grad-a),var(--grad-b));
      box-shadow:0 0 12px rgba(168,85,247,.4);
      transition:width .2s linear;
    }

    #word{letter-spacing:.25em; word-break:break-word; font-size:clamp(1.2rem,5vw,1.8rem); text-align:center}

    /* Turn indicator */
    #turnIndicator{
      font-weight:600; font-size:clamp(.95rem,3.2vw,1.05rem);
      color:transparent; background:linear-gradient(135deg,var(--grad-a),var(--grad-b));
      -webkit-background-clip:text; background-clip:text;
    }

    /* Keyboard grid */
    #letters{
      display:grid; grid-template-columns:repeat(auto-fit,minmax(34px,1fr));
      gap:6px; align-items:center; justify-items:center; padding:6px 2px; user-select:none;
    }
    #letters button{
      width:100%; min-width:34px; padding:.5rem .2rem;
      font-size:clamp(.8rem,3.2vw,1rem); font-weight:700; color:#111;
      border:none; border-radius:8px; cursor:pointer; position:relative; overflow:hidden;
      background:linear-gradient(135deg,var(--grad-a),var(--grad-b));
      background-size:200% 200%; animation:shineMove 5s ease infinite;
      box-shadow:0 6px 18px rgba(168,85,247,.25);
      transition:transform .15s ease, filter .15s ease, opacity .15s ease;
    }
    @keyframes shineMove{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    #letters button:hover:not(:disabled){transform:translateY(-2px)}
    #letters button:disabled{opacity:.35; cursor:default; filter:saturate(.7)}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(168,85,247,.35)}70%{box-shadow:0 0 0 10px rgba(168,85,247,0)}100%{box-shadow:0 0 0 0 rgba(168,85,247,0)}}
    #letters.activeTurn button:not(:disabled){animation:shineMove 5s ease infinite, pulse 1.6s infinite}
    #letters button.good{outline:2px solid #22c55e; box-shadow:0 0 0 4px rgba(34,197,94,.25)}
    #letters button.bad{outline:2px solid #ef4444; box-shadow:0 0 0 4px rgba(239,68,68,.25)}

    /* Messages */
    #message{color:var(--text); text-align:center; min-height:1.4em; transition:opacity .35s ease; opacity:.9}
    .fade{opacity:0}

    /* Setup */
    #setup input,#setup button{
      font-family:"Poppins",sans-serif; font-weight:600; border:none; border-radius:10px;
      padding:.9rem 1rem; font-size:clamp(.95rem,3.5vw,1rem); outline:none;
    }
    #wordInput{width:70%; background:#222; color:#fff; border:1px solid #333}
    #createBtn{color:#111; background:linear-gradient(135deg,var(--grad-a),var(--grad-b)); box-shadow:0 6px 18px rgba(236,72,153,.25); cursor:pointer}
    #createBtn:hover{transform:translateY(-2px)}

    #restartBtn,#newWordBtn{
      display:none; margin-top:6px; color:#111; cursor:pointer;
      background:linear-gradient(135deg,var(--grad-a),var(--grad-b));
      border:none; border-radius:10px; padding:.8rem 1rem; font-weight:700;
      box-shadow:0 6px 18px rgba(168,85,247,.25);
    }
    #restartBtn:hover,#newWordBtn:hover{transform:translateY(-2px)}

    .blink{animation:blink 1.5s infinite}
    @keyframes blink{0%,90%,100%{opacity:1}95%{opacity:.2}}

    /* Right column: Chat / lobby */
    #chatCard{
      background:rgba(255,255,255,0.05);
      border:1px solid #2b2b30; border-radius:12px; padding:10px;
      display:flex; flex-direction:column; gap:8px; min-height:0;
    }
    #chatHeader{
      display:flex; align-items:center; justify-content:space-between;
      font-weight:600; color:transparent; background:linear-gradient(135deg,var(--grad-a),var(--grad-b));
      -webkit-background-clip:text; background-clip:text;
    }
    #typingIndicator{ font-size:.9rem; color:var(--text-dim); min-height:1.2em }
    #chatList{
      flex:1; min-height:0; overflow:auto;
      display:flex; flex-direction:column; gap:6px;
      padding-right:4px;
    }
    .chatMsg{
      background:rgba(255,255,255,0.06); border:1px solid #35353a; border-radius:10px;
      padding:8px 10px; font-size:.95rem;
    }
    .chatMeta{ font-size:.75rem; color:var(--text-dim); margin-top:2px }
    #chatInputRow{ display:flex; gap:6px }
    #chatText{
      flex:1; border-radius:10px; border:1px solid #333; background:#222; color:#fff; padding:.7rem .9rem;
    }
    #chatSend{ min-width:84px }
  </style>
</head>

<body>
  <!-- Ambient particles -->
  <canvas id="bgParticles"></canvas>

  <div id="gameContainer">
    <h1>H√ÑNGA GUBBE</h1>

    <!-- Left column -->
    <div id="leftCol">
      <div id="setup">
        <input id="wordInput" placeholder="Skriv ett ord..." />
        <button id="createBtn">Skapa spel</button>
      </div>

      <div id="game" style="display:none;">
        <div id="scoreboard">
          <div>
            üßë Axwell: <span id="scoreHost" class="score">0</span>
            <div id="hostTotals" class="totals"></div>
          </div>
          <div>|</div>
          <div>
            üë§ G√§st: <span id="scoreGuest" class="score">0</span>
            <div id="guestTotals" class="totals"></div>
          </div>
        </div>
        <div id="youAre"></div>

        <!-- Host-only timer config -->
        <div id="timerConfig">
          <label for="timerInput">St√§ll in tid (0‚Äì100s):</label>
          <input id="timerInput" type="number" min="0" max="100" value="0" />
          <button id="timerSetBtn" class="btn">‚úÖ Bekr√§fta</button>
          <button id="timerToggleBtn" class="btn" style="display:none;">‚è∏Ô∏è Ta bort timer</button>
        </div>

        <div id="hangZone">
          <canvas id="hangman"></canvas>

          <!-- Modern timer bar -->
          <div id="timerBar"><div id="timerFill"></div></div>

          <div id="word">_</div>
        </div>

        <div id="turnIndicator"></div>

        <div id="letters"></div>

        <div id="message"></div>
        <p id="link"></p>

        <button id="restartBtn">üîÅ Spela igen</button>
        <button id="newWordBtn">‚úçÔ∏è V√§lj nytt ord</button>
      </div>
    </div>

    <!-- Right column: Chat + Lobby -->
    <div id="rightCol">
      <div id="chatCard">
        <div id="chatHeader">
          <div>üí¨ Lobby</div>
          <div id="typingIndicator"></div>
        </div>
        <div id="chatList"></div>
        <div id="chatInputRow">
          <input id="chatText" placeholder="Skriv ett meddelande..." />
          <button id="chatSend" class="btn">Skicka</button>
        </div>
      </div>

      <div id="lobby" class="totals"></div>
    </div>
  </div>

  <script>
  window.onload = () => {
    /* ---------- Firebase ---------- */
    const firebaseConfig = {
      apiKey: "AIzaSyAN9URR47HIBwIuBP3kSu5Rv_Ys0ef72-Q",
      authDomain: "hangman-6a99e.firebaseapp.com",
      databaseURL: "https://hangman-6a99e-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "hangman-6a99e",
      storageBucket: "hangman-6a99e.firebasestorage.app",
      messagingSenderId: "992689481911",
      appId: "1:992689481911:web:6461e931ba4d96879ec532",
      measurementId: "G-W1HFVTC23L"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    /* ---------- DOM ---------- */
    const setup = document.getElementById("setup");
    const gameDiv = document.getElementById("game");
    const lettersDiv = document.getElementById("letters");
    const wordDiv = document.getElementById("word");
    const msg = document.getElementById("message");
    const lobbyDiv = document.getElementById("lobby");
    const linkEl = document.getElementById("link");
    const restartBtn = document.getElementById("restartBtn");
    const newWordBtn = document.getElementById("newWordBtn");
    const turnIndicator = document.getElementById("turnIndicator");
    const scoreHostEl = document.getElementById("scoreHost");
    const scoreGuestEl = document.getElementById("scoreGuest");
    const hostTotalsEl = document.getElementById("hostTotals");
    const guestTotalsEl = document.getElementById("guestTotals");
    const youAreEl = document.getElementById("youAre");
    const canvas = document.getElementById("hangman");
    const ctx = canvas.getContext("2d");

    // Timer UI
    const timerBar = document.getElementById("timerBar");
    const timerFill = document.getElementById("timerFill");
    const timerConfig = document.getElementById("timerConfig");
    const timerInput = document.getElementById("timerInput");
    const timerSetBtn = document.getElementById("timerSetBtn");
    const timerToggleBtn = document.getElementById("timerToggleBtn");

    // Chat UI
    const chatList = document.getElementById("chatList");
    const chatText = document.getElementById("chatText");
    const chatSend = document.getElementById("chatSend");
    const typingIndicator = document.getElementById("typingIndicator");

    /* ---------- State ---------- */
    const letters = [..."ABCDEFGHIJKLMNOPQRSTUVWXYZ√Ö√Ñ√ñ"];
    const urlParams = new URLSearchParams(location.search);
    const gameId = urlParams.get("game");
    let nickname = "Axwell";
    let isHost = false;

    // Profiles
    let profileId = localStorage.getItem("profileId");
    if (!profileId) {
      profileId = "u_" + Math.random().toString(36).slice(2, 10);
      localStorage.setItem("profileId", profileId);
    }

    // Gradient hangman animation
    let gradPhase = 0;      // 0..1
    let currentWrong = 0;

    // Scores and updates
    let lastScores = { host: 0, guest: 0 };
    let lastUpdateKey = ""; // de-dupe Firebase events

    // Timer state
    let timerSeconds = 0;
    let roundStartMs = 0;
    let timerRAF = null;
    let timerEndedThisRound = false;

    /* ---------- Ambient particle background ---------- */
    const bg = document.getElementById("bgParticles");
    const g2 = bg.getContext("2d");
    function resizeBg(){
      bg.width = window.innerWidth; bg.height = window.innerHeight;
    }
    window.addEventListener("resize", resizeBg); resizeBg();
    const particles = Array.from({length: 26}).map(()=>({
      x: Math.random()*bg.width,
      y: Math.random()*bg.height,
      r: 1.5+Math.random()*3,
      dx: (-0.2+Math.random()*0.4),
      dy: (0.1+Math.random()*0.3),
      hue: Math.random()
    }));
    function drawParticles(){
      g2.clearRect(0,0,bg.width,bg.height);
      particles.forEach(p=>{
        p.x+=p.dx; p.y+=p.dy; p.hue+=0.0015;
        if(p.x<-20) p.x=bg.width+20; if(p.x>bg.width+20) p.x=-20;
        if(p.y>bg.height+20) {p.y=-20; p.x=Math.random()*bg.width;}
        const c1 = "#a855f7", c2="#ec4899";
        const grd = g2.createRadialGradient(p.x,p.y,0,p.x,p.y,p.r*6);
        grd.addColorStop(0,c1); grd.addColorStop(1,c2);
        g2.fillStyle = grd; g2.globalAlpha=0.18;
        g2.beginPath(); g2.arc(p.x,p.y,p.r*3,0,Math.PI*2); g2.fill();
        g2.globalAlpha=1;
      });
      requestAnimationFrame(drawParticles);
    }
    requestAnimationFrame(drawParticles);

    /* ---------- Layout helpers ---------- */
    function resizeCanvas() {
      const H = gameDiv.clientHeight || 520;
      const avail = H * 0.36; // ~36% for canvas
      const w = Math.min(window.innerWidth * 0.65, 360);
      const h = Math.min(avail, w * 1.25);
      canvas.width = w; canvas.height = h;
      drawAll(currentWrong);
    }
    window.addEventListener("resize", resizeCanvas);

    function showFadeMessage(text, duration = 2200) {
      msg.textContent = text;
      msg.classList.remove("fade");
      setTimeout(() => msg.classList.add("fade"), duration);
    }
    function popScore(el) {
      el.style.transform = "scale(1.25)";
      setTimeout(() => (el.style.transform = "scale(1)"), 220);
    }
    function vibrate(pattern){ if (navigator.vibrate) try{ navigator.vibrate(pattern); }catch(e){} }

    /* ---------- Keyboard ---------- */
    function createLetterButtons(id) {
      lettersDiv.innerHTML = "";
      letters.forEach(ch => {
        const btn = document.createElement("button");
        btn.textContent = ch;

        btn.addEventListener("click", async () => {
          if (btn.disabled) return;
          btn.disabled = true;

          const snap = await db.ref("games/" + id).get();
          const data = snap.val() || {};
          if (!data.word) { alert("Spelet √§r inte laddat √§n!"); return; }
          if (data.over) return;

          const myRole = nickname === "Axwell" ? "host" : "guest";
          if (data.turn !== myRole) { alert("Inte din tur!"); return; }

          const guesses = Array.isArray(data.guesses) ? data.guesses : [];
          if (guesses.includes(ch)) return;

          let correct = false;
          const newGuesses = [...guesses, ch];
          let newWrong = data.wrong || 0;
          let over = !!data.over;
          const scores = data.scores || { host: 0, guest: 0 };
          let winner = data.winner || null;

          if (!data.word.includes(ch)) {
            newWrong++; vibrate(100);
          } else {
            correct = true;
          }

          const solved = data.word.split("").every(l => newGuesses.includes(l));
          if (solved) {
            over = true; winner = data.turn;                     // guesser wins
            scores[winner] = (scores[winner] || 0) + 1;
            vibrate([120,60,120]);
          } else if (newWrong >= 6) {
            over = true; const opp = data.turn === "host" ? "guest" : "host";
            winner = opp; scores[opp] = (scores[opp] || 0) + 1;  // opponent wins
            vibrate([120,60,120]);
          }

          await db.ref("games/" + id).update({
            guesses: newGuesses,
            wrong: newWrong,
            over, scores, winner
          });

          btn.classList.add(correct ? "good" : "bad");
          setTimeout(() => btn.classList.remove("good", "bad"), 450);
        });

        lettersDiv.appendChild(btn);
      });
    }

    /* ---------- Word UI ---------- */
    function showWord(word, guesses) {
      guesses = guesses || [];
      wordDiv.textContent = word.split("").map(l => (guesses.includes(l) ? l : "_")).join(" ");
    }

    /* ---------- Gradient hangman ---------- */
    function strokeGradient(ctx) {
      const w = canvas.width, h = canvas.height;
      const g = ctx.createLinearGradient(
        w * (0.2 + 0.6 * gradPhase), 0,
        0, h * (0.8 + 0.6 * (1 - gradPhase))
      );
      g.addColorStop(0,   "#a855f7");
      g.addColorStop(0.5, "#ec4899");
      g.addColorStop(1,   "#a855f7");
      return g;
    }
    function drawAll(wrong) {
      const cw = canvas.width, ch = canvas.height;
      const sX = cw / 200, sY = ch / 250;
      const lw = 2 * Math.min(sX, sY);
      ctx.clearRect(0, 0, cw, ch);

      ctx.lineWidth = lw;
      ctx.strokeStyle = strokeGradient(ctx);

      // base + gallows
      ctx.beginPath();
      ctx.moveTo(10*sX,240*sY); ctx.lineTo(190*sX,240*sY);
      ctx.moveTo(50*sX,240*sY); ctx.lineTo(50*sX,20*sY);
      ctx.lineTo(130*sX,20*sY); ctx.lineTo(130*sX,50*sY);
      ctx.stroke();

      if (wrong > 0) { ctx.beginPath(); ctx.arc(130*sX,70*sY,20*sX,0,Math.PI*2); ctx.stroke(); }
      if (wrong > 1) { ctx.beginPath(); ctx.moveTo(130*sX,90*sY); ctx.lineTo(130*sX,160*sY); ctx.stroke(); }
      if (wrong > 2) { ctx.beginPath(); ctx.moveTo(130*sX,110*sY); ctx.lineTo(100*sX,140*sY); ctx.stroke(); }
      if (wrong > 3) { ctx.beginPath(); ctx.moveTo(130*sX,110*sY); ctx.lineTo(160*sX,140*sY); ctx.stroke(); }
      if (wrong > 4) { ctx.beginPath(); ctx.moveTo(130*sX,160*sY); ctx.lineTo(110*sX,200*sY); ctx.stroke(); }
      if (wrong > 5) { ctx.beginPath(); ctx.moveTo(130*sX,160*sY); ctx.lineTo(150*sX,200*sY); ctx.stroke(); }
    }
    function loop() {
      gradPhase += 0.003;
      if (gradPhase > 1) gradPhase -= 1;
      drawAll(currentWrong);
      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);

    /* ---------- Presence ---------- */
    const connectedRef = db.ref(".info/connected");
    function setupPresence(id, role) {
      connectedRef.on("value", snap => {
        if (snap.val()) {
          const pref = db.ref(`games/${id}/players/${role}`);
          pref.onDisconnect().remove();
        }
      });
    }

    /* ---------- Timer helpers ---------- */
    function startTimerLoop() {
      cancelTimerLoop();
      if (timerSeconds <= 0 || !roundStartMs) {
        timerBar.style.display = "none";
        return;
      }
      timerBar.style.display = "block";
      timerEndedThisRound = false;

      const tick = async () => {
        const now = Date.now();
        const elapsed = Math.max(0, now - roundStartMs);
        const remainMs = Math.max(0, (timerSeconds * 1000) - elapsed);
        const pct = Math.max(0, Math.min(1, remainMs / (timerSeconds * 1000)));
        timerFill.style.width = (pct * 100).toFixed(2) + "%";

        if (remainMs <= 0 && !timerEndedThisRound) {
          timerEndedThisRound = true;
          // Only host enforces timeout (prevents double-finishes)
          if (isHost) {
            const snap = await db.ref("games/" + gameId).get();
            const data = snap.val();
            if (data && !data.over) {
              const opponent = data.turn === "host" ? "guest" : "host";
              const scores = data.scores || { host: 0, guest: 0 };
              scores[opponent] = (scores[opponent] || 0) + 1;
              await db.ref("games/" + gameId).update({
                over: true,
                scores,
                winner: opponent
              });
              showFadeMessage("‚è∞ Tiden tog slut!");
              vibrate([120,60,120]);
            }
          }
        }
        timerRAF = requestAnimationFrame(tick);
      };
      timerRAF = requestAnimationFrame(tick);
    }
    function cancelTimerLoop() {
      if (timerRAF) cancelAnimationFrame(timerRAF);
      timerRAF = null;
      timerFill.style.width = "0%";
    }

    /* ---------- Create game (host) ---------- */
    document.getElementById("createBtn").onclick = async () => {
      const word = (document.getElementById("wordInput").value || "").trim().toUpperCase();
      if (!word.match(/^[A-Z√Ö√Ñ√ñ]+$/)) return alert("Endast bokst√§ver (A‚Äì√ñ) till√•tna!");
      const id = "hangman-" + Math.random().toString(36).substr(2, 5);

      await db.ref("games/" + id).set({
        word, guesses: [], wrong: 0, over: false,
        players: { host: "Axwell", hostPid: profileId },
        turn: "guest",
        scores: { host: 0, guest: 0 },
        settings: { timerSeconds: 0 },
        roundStartMs: firebase.database.ServerValue.TIMESTAMP,
        winner: null,
        awardRecorded: false
      });

      // ensure profile exists
      await db.ref("users/" + profileId).update({ name: "Axwell", wins: 0, losses: 0 });

      localStorage.setItem("createdGameId", id);
      window.location.href = `${location.origin}${location.pathname}?game=${id}`;
    };

    /* ---------- Chat ---------- */
    function appendChatMsg(msgObj){
      const li = document.createElement("div");
      li.className = "chatMsg";
      li.innerHTML = `<div>${escapeHtml(msgObj.name||"??")}: ${escapeHtml(msgObj.text||"")}</div>
                      <div class="chatMeta">${formatTime(msgObj.ts||Date.now())}</div>`;
      chatList.appendChild(li);
      chatList.scrollTop = chatList.scrollHeight;
    }
    function formatTime(ts){
      const d = new Date(ts);
      return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    }
    function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    function setupChat(gameId){
      db.ref(`games/${gameId}/chat`).limitToLast(100).on("child_added", snap=>{
        const v = snap.val(); appendChatMsg(v);
      });

      // typing indicator (chat)
      let typingTimeout = null;
      chatText.addEventListener("input", async ()=>{
        await db.ref(`games/${gameId}/typing/${isHost?'host':'guest'}`).set(true);
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(()=> {
          db.ref(`games/${gameId}/typing/${isHost?'host':'guest'}`).set(false);
        }, 1000);
      });

      db.ref(`games/${gameId}/typing`).on("value", snap=>{
        const t = snap.val()||{};
        const otherTyping = isHost ? t.guest : t.host;
        typingIndicator.textContent = otherTyping ? "‚úçÔ∏è Skriver..." : "";
      });

      async function sendChat(){
        const text = chatText.value.trim();
        if(!text) return;
        chatText.value = "";
        await db.ref(`games/${gameId}/chat`).push({
          name: nickname, text, ts: firebase.database.ServerValue.TIMESTAMP
        });
        // stop typing
        db.ref(`games/${gameId}/typing/${isHost?'host':'guest'}`).set(false);
      }
      chatSend.onclick = sendChat;
      chatText.addEventListener("keydown", e=>{ if(e.key==="Enter") sendChat(); });
    }

    /* ---------- Join/host existing game ---------- */
    if (gameId) {
      setup.style.display = "none";
      gameDiv.style.display = "block";
      resizeCanvas();

      db.ref("games/" + gameId).get().then(async snap => {
        if (!snap.exists()) { msg.textContent = "‚ùå Spelet kunde inte hittas."; return; }

        const data = snap.val();
        const isCreator = localStorage.getItem("createdGameId") === gameId;
        isHost = isCreator;

        if (!isCreator) {
          if (!sessionStorage.getItem("askedNick")) {
            const asked = prompt("Ange ditt namn:") || "G√§st";
            sessionStorage.setItem("askedNick", "1");
            localStorage.setItem("hangmanNick", asked);
          }
          nickname = localStorage.getItem("hangmanNick") || "G√§st";

          // set guest name + profile id
          await db.ref(`games/${gameId}/players`).update({ guest: nickname, guestPid: profileId });
          await db.ref("users/" + profileId).update({ name: nickname, wins: 0, losses: 0 });
        } else {
          nickname = "Axwell";
          await db.ref("users/" + profileId).update({ name: "Axwell", wins: 0, losses: 0 });
        }

        setupPresence(gameId, isCreator ? "host" : "guest");
        youAreEl.textContent = `Du √§r: ${nickname}`;

        // Timer config visibility
        updateTimerConfigVisibility(data);

        lastScores = data.scores || { host: 0, guest: 0 };
        currentWrong = data.wrong || 0;
        timerSeconds = data.settings?.timerSeconds || 0;
        roundStartMs = data.roundStartMs || 0;

        drawAll(currentWrong);
        showWord(data.word, data.guesses || []);
        createLetterButtons(gameId);
        linkEl.innerHTML = `Dela denna l√§nk: <a href="${location.origin}${location.pathname}?game=${gameId}" target="_blank">${location.origin}${location.pathname}?game=${gameId}</a>`;

        // host-only timer controls
        if (isHost) {
          timerSetBtn.onclick = async () => {
            const val = Math.max(0, Math.min(100, Number(timerInput.value || 0)));
            await db.ref("games/" + gameId + "/settings").update({ timerSeconds: val });
            if (!(data.guesses && data.guesses.length)) {
              await db.ref("games/" + gameId).update({
                roundStartMs: firebase.database.ServerValue.TIMESTAMP
              });
            }
          };
          timerToggleBtn.onclick = async () => {
            await db.ref("games/" + gameId + "/settings").update({ timerSeconds: 0 });
          };
        }

        setupChat(gameId);
        listenToGame(gameId);
        fetchAndShowTotals(); // profiles totals
      });
    } else {
      document.getElementById("wordInput").focus();
    }

    async function fetchAndShowTotals(){
      const pHost = db.ref("users"); // we need PIDs from game
      const snap = await db.ref("games/" + gameId + "/players").get();
      const pl = snap.val() || {};
      const [hostPid, guestPid] = [pl.hostPid, pl.guestPid];

      if (hostPid) db.ref("users/" + hostPid).on("value", s=>{
        const u = s.val()||{}; hostTotalsEl.textContent = `Vinster: ${u.wins||0}  F√∂rluster: ${u.losses||0}`;
      });
      if (guestPid) db.ref("users/" + guestPid).on("value", s=>{
        const u = s.val()||{}; guestTotalsEl.textContent = `Vinster: ${u.wins||0}  F√∂rluster: ${u.losses||0}`;
      });
    }

    function updateTimerConfigVisibility(data) {
      const guestJoined = !!(data.players && data.players.guest);
      const noGuessesYet = !(data.guesses && data.guesses.length);
      if (isHost && guestJoined && noGuessesYet) {
        timerConfig.style.display = "flex";
      } else {
        timerConfig.style.display = "none";
      }
      const t = data.settings?.timerSeconds || 0;
      timerToggleBtn.style.display = isHost && t > 0 ? "inline-block" : "none";
    }

    /* ---------- Live listener (de-duped) ---------- */
    function listenToGame(id) {
      db.ref("games/" + id).on("value", async snap => {
        const data = snap.val();
        if (!data || !data.word || !Array.isArray(data.guesses)) return;

        const key = JSON.stringify([data.guesses, data.wrong, data.over, data.turn, data.scores, data.settings, data.roundStartMs, data.winner, data.awardRecorded]);
        if (key === lastUpdateKey) return;
        lastUpdateKey = key;

        // Timer settings
        timerSeconds = data.settings?.timerSeconds || 0;
        roundStartMs = data.roundStartMs || 0;
        updateTimerConfigVisibility(data);

        if (data.over || timerSeconds <= 0) {
          cancelTimerLoop();
          timerBar.style.display = timerSeconds>0 && !data.over ? "block":"none";
        } else {
          if (isHost) startTimerLoop();
          else timerBar.style.display = timerSeconds>0 ? "block":"none";
        }

        // Word / drawing / scores
        const guesses = data.guesses;
        showWord(data.word, guesses);
        currentWrong = Number(data.wrong) || 0;

        if ((data.scores?.host || 0) !== lastScores.host) popScore(scoreHostEl);
        if ((data.scores?.guest || 0) !== lastScores.guest) popScore(scoreGuestEl);
        lastScores = { host: data.scores?.host || 0, guest: data.scores?.guest || 0 };
        scoreHostEl.textContent = lastScores.host;
        scoreGuestEl.textContent = lastScores.guest;

        // Lobby
        const players = data.players || {};
        const guestJoined = !!players.guest;
        lobbyDiv.innerHTML =
          `üßë ${players.host || "Ok√§nd"} (v√§rd) ‚Äî PID: ${players.hostPid || "-"}<br>` +
          `üë§ ${players.guest || "Ingen ansluten √§nnu"} ‚Äî PID: ${players.guestPid || "-"}<br>` +
          `${guestJoined ? "üéÆ B√•da spelare anslutna!" : "‚è≥ V√§ntar p√• spelare ..."}`;

        // Turn
        const myRole = nickname === "Axwell" ? "host" : "guest";
        if (data.turn === myRole) {
          turnIndicator.textContent = "üéØ Din tur att gissa!";
          lettersDiv.classList.add("activeTurn");
        } else {
          turnIndicator.innerHTML = "‚è≥ V√§nta p√• din tur <span class='blink'>üëÄ</span>";
          lettersDiv.classList.remove("activeTurn");
        }

        // Buttons
        const allBtns = document.querySelectorAll("#letters button");
        allBtns.forEach(b => (b.disabled = false));
        allBtns.forEach(b => { if (guesses.includes(b.textContent)) b.disabled = true; });

        // End-of-round controls + award global profiles (host only, once)
        if (data.over) {
          msg.textContent = data.winner
            ? (data.winner === "host" ? "üéâ V√§rden vann!" : "üéâ G√§sten vann!")
            : (data.wrong >= 6 ? `üíÄ Du f√∂rlorade! Ordet var ${data.word}` : "üéâ Du vann!");
          restartBtn.style.display = "inline-block";
          newWordBtn.style.display = "inline-block";
          restartBtn.scrollIntoView({ block: "nearest" });

          // Award persistence once per round
          if (isHost && !data.awardRecorded && data.winner && data.players) {
            const winPid = data.winner === "host" ? data.players.hostPid : data.players.guestPid;
            const losePid = data.winner === "host" ? data.players.guestPid : data.players.hostPid;
            if (winPid) await db.ref("users/" + winPid + "/wins").transaction(v => (v||0)+1);
            if (losePid) await db.ref("users/" + losePid + "/losses").transaction(v => (v||0)+1);
            await db.ref("games/" + id).update({ awardRecorded: true });
          }
        } else {
          restartBtn.style.display = "none";
          newWordBtn.style.display = "none";
          msg.textContent = "";
        }
      });
    }

    /* ---------- Actions ---------- */
    restartBtn.onclick = async () => {
      const snap = await db.ref("games/" + gameId).get();
      const data = snap.val(); if (!data) return;
      await db.ref("games/" + gameId).update({
        guesses: [], wrong: 0, over: false,
        roundStartMs: firebase.database.ServerValue.TIMESTAMP,
        winner: null, awardRecorded: false
      });
      currentWrong = 0;
      createLetterButtons(gameId);
      showFadeMessage("üîÅ Ny runda!");
    };

    newWordBtn.onclick = async () => {
      const snap = await db.ref("games/" + gameId).get();
      const data = snap.val();
      if (!data?.over) return alert("Rundan √§r inte slut √§n!");

      // typing indicator (word choosing)
      await db.ref(`games/${gameId}/typing/${isHost?'host':'guest'}`).set(true);
      const newWord = (prompt("Ange nytt ord:") || "").toUpperCase();
      await db.ref(`games/${gameId}/typing/${isHost?'host':'guest'}`).set(false);

      if (!newWord.match(/^[A-Z√Ö√Ñ√ñ]+$/)) return alert("Endast bokst√§ver (A‚Äì√ñ) till√•tna!");
      const nextTurn = data.turn === "host" ? "guest" : "host";
      await db.ref("games/" + gameId).set({
        word: newWord, guesses: [], wrong: 0, over: false,
        players: data.players, turn: nextTurn, scores: data.scores,
        settings: data.settings || { timerSeconds: 0 },
        roundStartMs: firebase.database.ServerValue.TIMESTAMP,
        winner: null, awardRecorded: false
      });
      currentWrong = 0;
      createLetterButtons(gameId);
      showFadeMessage("‚úçÔ∏è Nytt ord valt!");
    };

    // Initial size
    resizeCanvas();
  };
  </script>
</body>
</html>
