<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <!-- =========================================================
       VIEWPORT (NYTT: scale-locked för mobil, ingen zoom)
  ========================================================== -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>HÄNGA GUBBE</title>

  <!-- =========================================================
       FONTS & FIREBASE SDKs (samma projekt)
  ========================================================== -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>

  <style>
    /* =========================================================
       DESIGN-TOKENS / TEMA (glassmorphism + neon)
    ========================================================== */
    :root{
      --grad-a:#ec4899; --grad-b:#a855f7;
      --bg1:#0e0e11; --bg2:#1a1a1f;
      --panel:rgba(255,255,255,.08);
      --text:#fff; --text-dim:#bdbdbd;
      --ok:#22c55e; --bad:#ef4444;
    }
    *{box-sizing:border-box}

    /* =========================================================
       LAYOUT (NYTT: no-page-scroll, mobilvänligt)
    ========================================================== */
    body{
      margin:0; font-family:"Poppins",sans-serif; color:var(--text);
      background: radial-gradient(circle at 20% 20%, #18181d, #0e0e11 70%), linear-gradient(160deg, var(--bg1), var(--bg2));
      height:100dvh; /* lås höjd */
      display:grid; place-items:center; padding:10px; overflow:hidden; /* NYTT: ingen sidscroll */
    }
    h1{
      font-weight:700; text-align:center; margin:0 0 12px;
      font-size:clamp(1.25rem, 2.8vw, 1.75rem);
      background:linear-gradient(135deg,var(--grad-a),var(--grad-b));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    }
    .card{
      width:min(880px, 98vw);
      height:min(96dvh, 860px);          /* NYTT: lås kortets höjd */
      background:var(--panel);
      border-radius:18px; backdrop-filter:blur(12px);
      box-shadow:0 0 25px rgba(0,0,0,.6);
      padding:14px; position:relative;
      display:flex; flex-direction:column; gap:10px; overflow:hidden; /* NYTT: intern layout */
    }

    /* =========================================================
       FORM-LAYOUTS (NYTT: inga överlapp)
    ========================================================== */
    .stack > *{display:block; width:100%; margin-top:12px}
    .row{display:flex; gap:10px; align-items:center}
    .row > *{flex:1}
    label{font-size:.95rem; color:var(--text-dim)}
    input,select,button{
      font-family:inherit; font-size:1rem; border-radius:12px; border:1px solid #333; padding:.8rem 1rem;
      background:#222; color:#fff; display:block; width:100%;
    }
    select{background:#1f1f24}
    button{
      cursor:pointer; font-weight:700; color:#111; border:none; background:linear-gradient(135deg,var(--grad-a),var(--grad-b));
      box-shadow:0 6px 18px rgba(168,85,247,.25); transition:transform .15s ease, box-shadow .15s ease;
    }
    button:hover{transform:translateY(-2px); box-shadow:0 8px 22px rgba(168,85,247,.35)}
    .btn-ghost{background:transparent; color:var(--text); border:1px solid #3a3a3f; box-shadow:none}

    .start-icons{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px}
    .tag{font-size:.75rem; color:#111; background:rgba(255,255,255,.55); padding:.1rem .45rem; border-radius:999px; margin-left:.5rem}

    /* =========================================================
       LOBBY-BAR (NYTT: fix/sticky överst, med pulserande dots)
    ========================================================== */
    #lobbyBar{
      position:sticky; top:0; z-index:5; /* sticky inom kortet */
      background:linear-gradient(0deg, rgba(0,0,0,.0), rgba(0,0,0,.12));
      border:1px solid #2b2b30; border-radius:12px;
      padding:8px 10px; display:flex; gap:10px; justify-content:center; align-items:center;
      backdrop-filter:blur(10px);
    }
    .lobbyItem{display:flex; align-items:center; gap:8px; font-size:.95rem}
    .dot{
      width:10px; height:10px; border-radius:999px; display:inline-block; position:relative;
      box-shadow:0 0 0 0 rgba(255,255,255,0.25);
      animation:pulseDot 1.4s ease-in-out infinite;
    }
    .online{background:#22c55e}
    .offline{background:#ef4444}
    @keyframes pulseDot{0%{transform:scale(1);opacity:.9}50%{transform:scale(1.15);opacity:1}100%{transform:scale(1);opacity:.9}}

    /* Liten statusradstext */
    #lobbyMsg{font-size:.9rem; color:var(--text-dim)}

    /* =========================================================
       LADDNING (spinner) – NYTT
    ========================================================== */
    .loading{display:flex; align-items:center; justify-content:center; gap:10px; color:var(--text-dim); padding:6px 0}
    .spinner{width:18px;height:18px;border:3px solid rgba(255,255,255,.2); border-top-color:#fff; border-radius:50%; animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* =========================================================
       SPELDEL – höjdallokering (NYTT: mobiloptimering)
    ========================================================== */
    #gameMain{ /* container för allt utom lobbyBar */
      flex:1; display:flex; flex-direction:column; gap:8px; overflow:hidden;
    }
    #share{font-size:.9rem; color:var(--text-dim); word-break:break-all; text-align:center}
    #scoreboard{
      margin-top:2px; font-weight:700; text-align:center; font-size:clamp(1rem,2.6vw,1.2rem);
      background:linear-gradient(135deg,var(--grad-a),var(--grad-b));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    }
    #turnIndicator{margin-top:2px; text-align:center; font-weight:600; color:var(--text-dim); transition:opacity .25s, transform .25s}
    .turn-flash{opacity:0; transform:translateY(-4px)} /* NYTT: liten animation */

    /* Canvas – höjdbegränsning för mobil (NYTT) */
    #hangman{
      width:100%; aspect-ratio:200/250; background:#111; border:1px solid #333; border-radius:12px;
      max-height:36dvh; /* NYTT: så den inte tar över på mobile */
    }
    .shake{animation:shake .3s ease}
    @keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-4px)}50%{transform:translateX(4px)}75%{transform:translateX(-3px)}100%{transform:translateX(0)}}

    #word{letter-spacing:.25em; font-size:clamp(1.05rem,4vw,1.5rem); text-align:center}

    /* TIMER bar (NYTT: precis ovanför bokstäverna) */
    #timerBar{margin:4px 0 0; width:100%; height:10px; border-radius:999px; background:rgba(255,255,255,.08); overflow:hidden; display:none; position:relative}
    #timerFill{height:100%; width:0%; background:linear-gradient(90deg,var(--grad-a),var(--grad-b)); transition:width .2s linear, filter .2s linear}
    .pulse{animation:pulse 0.8s ease-in-out infinite}
    @keyframes pulse{0%{filter:brightness(1)}50%{filter:brightness(1.5)}100%{filter:brightness(1)}}

    /* Bokstavsraden (lite kompaktare för mobil) */
    #letters{display:grid; grid-template-columns:repeat(auto-fit,minmax(32px,1fr)); gap:6px; margin-top:6px}
    #letters button{padding:.5rem .25rem; border-radius:10px; color:#111; font-weight:800; border:none;
      background:linear-gradient(135deg,var(--grad-a),var(--grad-b)); box-shadow:0 6px 18px rgba(168,85,247,.25)}
    #letters button:disabled{opacity:.35; filter:saturate(.7); cursor:default}

    /* Chatt (egen scroll, resten låst) */
    #chatWrap{border:1px solid #2b2b30; border-radius:12px; background:rgba(255,255,255,.05); padding:8px; display:flex; flex-direction:column; gap:6px; min-height:0}
    #chatList{flex:1; min-height:60px; max-height:18dvh; overflow:auto; display:flex; flex-direction:column; gap:6px}
    .chatMsg{background:rgba(255,255,255,.06); border:1px solid #35353a; border-radius:10px; padding:6px 8px; font-size:.95rem; line-height:1.25; opacity:1; transition:opacity .6s ease}
    .chatMsg.fadeout{opacity:0}
    .chatMeta{font-size:.75rem; color:var(--text-dim); margin-top:2px}
    #chatRow{display:flex; gap:8px}
    #chatText{background:#222; color:#fff; border:1px solid #333; border-radius:10px; padding:.6rem .9rem; flex:1}
    #chatSend{min-width:110px}
    /* NYTT: fix – hindra global width:100% från att bredda knappen */
    #chatRow button{width:auto; flex:0 0 auto;}

    /* Actions */
    #actions{display:flex; gap:8px; justify-content:center; flex-wrap:wrap}
    .action{padding:.7rem 1rem; border-radius:12px; border:none; font-weight:700; cursor:pointer;
      background:linear-gradient(135deg,var(--grad-a),var(--grad-b)); color:#111; box-shadow:0 6px 18px rgba(168,85,247,.25)}
    .action.btn-ghost{background:transparent; color:var(--text); border:1px solid #3a3a3f; box-shadow:none}

    .hidden{display:none !important}
  </style>
</head>

<body>
  <!-- =========================================================
       START-SCREEN (språk + namn + skapa/gå med)
  ========================================================== -->
  <div id="start" class="card">
    <h1>HÄNGA GUBBE</h1>
    <div class="stack">
      <div>
        <label for="lang">Språk / Language</label>
        <select id="lang">
          <option value="sv">Svenska</option>
          <option value="en">English</option>
        </select>
      </div>

      <div>
        <label for="playerName" id="nameLabel">Ditt namn</label>
        <input id="playerName" placeholder="Ditt namn / Your name" />
      </div>

      <div class="start-icons">
        <button id="createBtn">🆕 Skapa spel <span class="tag">NEW</span></button>
        <button id="joinBtn">🔗 Gå med i spel <span class="tag">LINK</span></button>
      </div>

      <div id="joinArea" class="row">
        <input id="joinCode" placeholder="Spelkod (t.ex. ab123)" />
        <button id="joinGo">Gå med</button>
      </div>
    </div>
  </div>

  <!-- =========================================================
       GAME-SCREEN (lobbyBar + main content)
       NYTT: lobbyBar är sticky/fixerad överst och syns alltid
  ========================================================== -->
  <div id="game" class="card">
    <!-- LOBBY BAR (NYTT: status + pulserande indikatorer) -->
    <div id="lobbyBar">
      <div class="lobbyItem"><span id="dotHost" class="dot offline"></span>👑 <span id="nameHost">—</span></div>
      <div class="lobbyItem"><span id="dotGuest" class="dot offline"></span>👤 <span id="nameGuest">⏳ Väntar på spelare…</span></div>
      <div id="lobbyMsg" class="lobbyItem dim">—</div>
    </div>

    <!-- Allt annat ligger i en intern kolumn som kan innehålla scrollbara delar -->
    <div id="gameMain">
      <h1>HÄNGA GUBBE</h1>

      <!-- Laddningsindikator (spinner) -->
      <div id="loading" class="loading hidden">
        <div class="spinner"></div>
        <div id="loadingText" class="dim">Laddar spel…</div>
      </div>

      <!-- Delning & poäng -->
      <div id="share" class="dim"></div>
      <div id="scoreboard">🧑 0 | 👤 0</div>

      <!-- Turindikator (med liten flash vid byte) -->
      <div id="turnIndicator" class="dim">⏳ Väntar på tur…</div>

      <!-- Canvas + ord -->
      <canvas id="hangman"></canvas>
      <div id="word">_</div>

      <!-- Timerkontroller (host) -->
      <div class="row" id="timerControlsRow" style="justify-content:center; flex-wrap:wrap">
        <button id="timerOpen" class="action hidden" style="max-width:220px">⏱ Ställ in timer</button>
        <div id="timerConfig" class="row hidden" style="max-width:520px; width:100%;">
          <input id="timerInput" type="number" min="0" max="100" value="0" />
          <button id="timerConfirm" class="action">✅ Bekräfta</button>
          <button id="timerCancel" class="action btn-ghost">✖</button>
          <button id="timerOff" class="action btn-ghost">🕒 Av</button>
        </div>
      </div>

      <!-- TIMER bar (precis ovanför bokstäverna) -->
      <div id="timerBar"><div id="timerFill"></div></div>

      <!-- Bokstäver -->
      <div id="letters"></div>

      <!-- Chatt (egen scroll) -->
      <div id="chatWrap">
        <div id="chatList"></div>
        <div id="chatRow">
          <input id="chatText" placeholder="Skriv ett meddelande..." />
          <button id="chatSend">Skicka</button>
        </div>
      </div>

      <!-- Åtgärder -->
      <div id="actions">
        <button id="restartBtn" class="action hidden">🔁 Spela igen</button>
        <button id="newWordBtn" class="action hidden">✍️ Välj nytt ord</button>
        <button id="backBtn" class="action">⬅️ Tillbaka till start</button>
      </div>
    </div>
  </div>

  <script>
    /* =========================================================
       FIREBASE (samma projekt)
    ========================================================== */
    const firebaseConfig = {
      apiKey: "AIzaSyAN9URR47HIBwIuBP3kSu5Rv_Ys0ef72-Q",
      authDomain: "hangman-6a99e.firebaseapp.com",
      databaseURL: "https://hangman-6a99e-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "hangman-6a99e",
      storageBucket: "hangman-6a99e.firebasestorage.app",
      messagingSenderId: "992689481911",
      appId: "1:992689481911:web:6461e931ba4d96879ec532",
      measurementId: "G-W1HFVTC23L"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    /* =========================================================
       DOM-REFERENSER
    ========================================================== */
    const startDiv = document.getElementById("start");
    const gameDiv  = document.getElementById("game");
    const gameMain = document.getElementById("gameMain");

    const langSel  = document.getElementById("lang");
    const nameInput= document.getElementById("playerName");
    const nameLabel= document.getElementById("nameLabel");
    const createBtn= document.getElementById("createBtn");
    const joinBtn  = document.getElementById("joinBtn");
    const joinArea = document.getElementById("joinArea");
    const joinCodeInput = document.getElementById("joinCode");
    const joinGo   = document.getElementById("joinGo");

    // Lobby UI (NYTT)
    const dotHost = document.getElementById("dotHost");
    const dotGuest= document.getElementById("dotGuest");
    const nameHost= document.getElementById("nameHost");
    const nameGuest=document.getElementById("nameGuest");
    const lobbyMsg= document.getElementById("lobbyMsg");

    const loading  = document.getElementById("loading");
    const loadingText = document.getElementById("loadingText");
    const shareEl  = document.getElementById("share");
    const scoreEl  = document.getElementById("scoreboard");
    const turnEl   = document.getElementById("turnIndicator");
    const canvas   = document.getElementById("hangman");
    const ctx      = canvas.getContext("2d");
    const wordEl   = document.getElementById("word");
    const lettersEl= document.getElementById("letters");

    const chatList = document.getElementById("chatList");
    const chatText = document.getElementById("chatText");
    const chatSend = document.getElementById("chatSend");

    // Timer controls
    const timerOpen   = document.getElementById("timerOpen");
    const timerConfig = document.getElementById("timerConfig");
    const timerInput  = document.getElementById("timerInput");
    const timerConfirm= document.getElementById("timerConfirm");
    const timerCancel = document.getElementById("timerCancel");
    const timerOff    = document.getElementById("timerOff");
    const timerBar    = document.getElementById("timerBar");
    const timerFill   = document.getElementById("timerFill");

    const restartBtn = document.getElementById("restartBtn");
    const newWordBtn = document.getElementById("newWordBtn");
    const backBtn    = document.getElementById("backBtn");

    /* =========================================================
       STATE
    ========================================================== */
    const letters = [..."ABCDEFGHIJKLMNOPQRSTUVWXYZÅÄÖ"];
    const params  = new URLSearchParams(location.search);
    const deepLinkGame = params.get("game"); // t.ex. hangman-abc12

    let gameId = "";
    let isHost = false;
    let nickname = "";
    let lang = localStorage.getItem("lang") || "sv";
    langSel.value = lang;

    let timerSeconds = 0;
    let roundStartMs = 0;
    let rafTimer = null;
    let currentWrong = 0;
    let lastUpdateKey = "";
    let presenceRef = null; // NYTT: presence node for this client

    /* =========================================================
       I18N
    ========================================================== */
    const t = {
      sv: {
        name: "Ditt namn",
        enterWord: "Ange ett ord att spela med:",
        notFound: "Spelet hittades inte.",
        notYourTurn: "Inte din tur!",
        share: "Dela denna länk: ",
        loading: "Laddar spel…",
        yourTurn: "🎯 Din tur!",
        oppTurn: "⏳ Motståndarens tur...",
        timeRanOut: "⏰ Tiden tog slut!",
        hostWon: "🎉 Värden vann!",
        guestWon: "🎉 Gästen vann!",
        joinCodeMissing: "Ange spelkod.",
        confirmBack: "Är du säker på att du vill lämna och radera spelet? Detta går inte att ångra.",
        waiting: "⏳ Väntar på spelare…",
        bothIn: "🎮 Båda spelare anslutna!"
      },
      en: {
        name: "Your name",
        enterWord: "Enter a word to start:",
        notFound: "Game not found.",
        notYourTurn: "Not your turn!",
        share: "Share this link: ",
        loading: "Loading game…",
        yourTurn: "🎯 Your turn!",
        oppTurn: "⏳ Opponent's turn...",
        timeRanOut: "⏰ Time ran out!",
        hostWon: "🎉 Host won!",
        guestWon: "🎉 Guest won!",
        joinCodeMissing: "Enter a game code.",
        confirmBack: "Are you sure you want to leave and delete the game? This cannot be undone.",
        waiting: "⏳ Waiting for player…",
        bothIn: "🎮 Both players connected!"
      }
    };
    function i18n(){
      nameLabel.textContent = t[lang].name;
      chatText.placeholder = (lang==="sv")?"Skriv ett meddelande...":"Type a message...";
      loadingText.textContent = t[lang].loading;
      localStorage.setItem("lang", lang);
    }
    i18n();
    langSel.onchange = ()=>{ lang = langSel.value; i18n(); }

    /* =========================================================
       UTILS
    ========================================================== */
    function escapeHtml(s){return (s||"").replace(/[&<>\"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]))}
    function showLoading(show){ loading.classList.toggle("hidden", !show); }
    function ensureNamePrompt(){
      let stored = (nameInput.value || localStorage.getItem("nickname") || "").trim();
      if(!stored){ stored = prompt(lang==="sv"?"Ange ditt namn:":"Enter your name:") || ""; }
      stored = stored.trim() || (lang==="sv"?"Gäst":"Guest");
      nameInput.value = stored; localStorage.setItem("nickname", stored);
      return stored;
    }
    function linkFor(id){ return `${location.origin}${location.pathname}?game=${id}`; }

    /* =========================================================
       CANVAS (rita galge) + resize + shake
    ========================================================== */
    function resizeCanvas(){
      const w = Math.min(520, Math.floor(gameMain.clientWidth*0.98)); /* använd innerbredd av kortet */
      const h = Math.floor(w*1.25);
      canvas.width=w; canvas.height=h; drawAll(currentWrong);
    }
    window.addEventListener("resize", resizeCanvas);
    function strokeGrad(){
      const g=ctx.createLinearGradient(0,0,canvas.width,canvas.height);
      g.addColorStop(0,"#ec4899"); g.addColorStop(.5,"#a855f7"); g.addColorStop(1,"#ec4899"); return g;
    }
    function drawAll(wrong){
      const cw=canvas.width,ch=canvas.height; const sX=cw/200,sY=ch/250; const lw=2*Math.min(sX,sY);
      ctx.clearRect(0,0,cw,ch); ctx.lineWidth=lw; ctx.strokeStyle=strokeGrad();
      // bas + galge
      ctx.beginPath(); ctx.moveTo(10*sX,240*sY); ctx.lineTo(190*sX,240*sY);
      ctx.moveTo(50*sX,240*sY); ctx.lineTo(50*sX,20*sY); ctx.lineTo(130*sX,20*sY); ctx.lineTo(130*sX,50*sY); ctx.stroke();
      if(wrong>0){ctx.beginPath();ctx.arc(130*sX,70*sY,20*sX,0,Math.PI*2);ctx.stroke();}
      if(wrong>1){ctx.beginPath();ctx.moveTo(130*sX,90*sY);ctx.lineTo(130*sX,160*sY);ctx.stroke();}
      if(wrong>2){ctx.beginPath();ctx.moveTo(130*sX,110*sY);ctx.lineTo(100*sX,140*sY);ctx.stroke();}
      if(wrong>3){ctx.beginPath();ctx.moveTo(130*sX,110*sY);ctx.lineTo(160*sX,140*sY);ctx.stroke();}
      if(wrong>4){ctx.beginPath();ctx.moveTo(130*sX,160*sY);ctx.lineTo(110*sX,200*sY);ctx.stroke();}
      if(wrong>5){ctx.beginPath();ctx.moveTo(130*sX,160*sY);ctx.lineTo(150*sX,200*sY);ctx.stroke();}
    }

    /* =========================================================
       ORDET & BOKSTÄVER + canvas-shake på fel
    ========================================================== */
    function showWord(word, guesses){ wordEl.textContent = (word||"").split("").map(l => (guesses||[]).includes(l)?l:"_").join(" "); }
    function buildLetters(){
      lettersEl.innerHTML="";
      letters.forEach(ch=>{
        const b=document.createElement("button"); b.textContent=ch;
        b.onclick = async ()=>{
          const snap = await db.ref("games/"+gameId).get(); const d=snap.val();
          if(!d || d.over) return;
          const myRole = isHost ? "host":"guest";
          if(d.turn !== myRole){ alert((lang==="sv")?t.sv.notYourTurn:t.en.notYourTurn); return; }
          const guesses = d.guesses || [];
          if(guesses.includes(ch)) return;
          let newGuesses=[...guesses, ch];
          let newWrong=d.wrong||0; let over=false; let winner=null;
          const scores=d.scores||{host:0, guest:0};
          const wasWrong = !d.word.includes(ch);
          if(wasWrong){ newWrong++; canvas.classList.add("shake"); setTimeout(()=>canvas.classList.remove("shake"), 300); }
          const solved = d.word.split("").every(l=>newGuesses.includes(l));
          if(solved){ over=true; winner=d.turn; scores[winner]++; }
          else if(newWrong>=6){ over=true; const opp=d.turn==="host"?"guest":"host"; winner=opp; scores[opp]++; }
          await db.ref("games/"+gameId).update({ guesses:newGuesses, wrong:newWrong, over, scores, winner });
        };
        lettersEl.appendChild(b);
      });
    }

    /* =========================================================
       TIMER (0–100s, pulserar sista 3s, host styr)
    ========================================================== */
    function startTimerLoop(){
      stopTimerLoop();
      if(timerSeconds<=0 || !roundStartMs) { timerBar.style.display="none"; return; }
      timerBar.style.display="block";
      const step = async ()=>{
        const now = Date.now();
        const remainMs = Math.max(0, (timerSeconds*1000) - Math.max(0, now - roundStartMs));
        const pct = Math.max(0, Math.min(1, remainMs/(timerSeconds*1000)));
        timerFill.style.width = (pct*100).toFixed(2)+"%";
        timerFill.style.filter = `brightness(${1+(1-pct)*0.6})`;
        if(remainMs<=3000) timerFill.classList.add("pulse"); else timerFill.classList.remove("pulse");
        if(remainMs<=0){
          const snap = await db.ref("games/"+gameId).get();
          const d = snap.val();
          if(d && !d.over){
            const opponent = (d.turn==="host")?"guest":"host";
            const scores = d.scores || {host:0, guest:0};
            scores[opponent] = (scores[opponent]||0)+1;
            await db.ref("games/"+gameId).update({ over:true, scores, winner:opponent });
            pushTemporaryInfo((lang==="sv")?t.sv.timeRanOut:t.en.timeRanOut);
          }
          timerBar.style.display="none"; return;
        }
        rafTimer = requestAnimationFrame(step);
      };
      rafTimer = requestAnimationFrame(step);
    }
    function stopTimerLoop(){ if(rafTimer) cancelAnimationFrame(rafTimer); rafTimer=null; timerFill.style.width="0%"; timerFill.classList.remove("pulse"); }

    function showTimerControls(data){
      const guestJoined = !!(data.players && data.players.guest);
      const roundActive = !data.over;
      const tsec = data.settings?.timerSeconds || 0;
      if(isHost && guestJoined && roundActive){
        timerOpen.classList.toggle("hidden", tsec>0);
        timerConfig.classList.toggle("hidden", tsec>0 ? true : false);
        timerOff.classList.toggle("hidden", tsec===0);
      } else {
        timerOpen.classList.add("hidden");
        timerConfig.classList.add("hidden");
        timerOff.classList.add("hidden");
      }
    }
    timerOpen.onclick   = ()=>{ timerConfig.classList.remove("hidden"); timerOpen.classList.add("hidden"); };
    timerCancel.onclick = ()=>{ timerConfig.classList.add("hidden"); timerOpen.classList.remove("hidden"); };
    timerConfirm.onclick= async ()=>{
      const val = Math.max(0, Math.min(100, Number(timerInput.value||0)));
      await db.ref("games/"+gameId+"/settings").update({ timerSeconds:val });
      await db.ref("games/"+gameId).update({ roundStartMs: firebase.database.ServerValue.TIMESTAMP });
      timerConfig.classList.add("hidden");
    };
    timerOff.onclick    = async ()=>{
      await db.ref("games/"+gameId+"/settings").update({ timerSeconds:0 });
      await db.ref("games/"+gameId).update({ roundStartMs: 0 });
      timerConfig.classList.add("hidden"); timerOpen.classList.remove("hidden");
    };

    /* =========================================================
       CHATT (auto-fade)
    ========================================================== */
    function pushChat(text){
      db.ref("games/"+gameId+"/chat").push({ name:nickname, text, ts:firebase.database.ServerValue.TIMESTAMP });
    }
    function appendChat(obj){
      const wrap=document.createElement("div");
      wrap.className="chatMsg";
      wrap.innerHTML = `<div><b>${escapeHtml(obj.name||"??")}</b>: ${escapeHtml(obj.text||"")}</div><div class="chatMeta">${new Date(obj.ts||Date.now()).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>`;
      chatList.appendChild(wrap); chatList.scrollTop=chatList.scrollHeight;
      setTimeout(()=>wrap.classList.add("fadeout"),15000);
      setTimeout(()=>wrap.remove(),16500);
    }
    chatSend.onclick = ()=>{
      const v = chatText.value.trim(); if(!v) return; chatText.value="";
      pushChat(v);
    };
    chatText.addEventListener("keydown", e=>{ if(e.key==="Enter") chatSend.click(); });

    /* =========================================================
       TURINDIKATOR (flash vid byte)
    ========================================================== */
    function setTurn(turn){
      const mine = isHost ? "host":"guest";
      turnEl.classList.add("turn-flash");
      turnEl.textContent = (turn===mine) ? ((lang==="sv")?t.sv.yourTurn:t.en.yourTurn) : ((lang==="sv")?t.sv.oppTurn:t.en.oppTurn);
      setTimeout(()=>turnEl.classList.remove("turn-flash"), 10);
    }

    /* =========================================================
       LOBBY (NYTT): presence + sticky bar
       - skriver in namn
       - pulserande dot (grön/röd)
       - "väntar på spelare" / "båda anslutna"
    ========================================================== */
    function updateLobbyBar(players={}, presence={}){
      // Namn
      nameHost.textContent  = players.host  || "—";
      nameGuest.textContent = players.guest || ((lang==="sv")?"⏳ Väntar på spelare…":"⏳ Waiting for player…");

      // Presence → dot färg
      const hostOn  = !!presence.host;
      const guestOn = !!presence.guest;
      dotHost.classList.toggle("online", hostOn);
      dotHost.classList.toggle("offline", !hostOn);
      dotGuest.classList.toggle("online", guestOn);
      dotGuest.classList.toggle("offline", !guestOn);

      // Meddelande
      lobbyMsg.textContent = (players.host && players.guest)
        ? ((lang==="sv")?t.sv.bothIn:t.en.bothIn)
        : ((lang==="sv")?t.sv.waiting:t.en.waiting);
    }

    // Sätt presence för aktuell klient (NYTT)
    function setupPresence(id, role){
      // .info/connected säger om *denna* klient är uppkopplad mot RTDB
      firebase.database().ref(".info/connected").on("value", snap=>{
        if(snap.val()){
          // skapa presence-nod och rensa vid disconnect
          presenceRef = db.ref(`games/${id}/presence/${role}`);
          presenceRef.set(true);
          presenceRef.onDisconnect().remove();
        }
      });
    }

    /* =========================================================
       FLOW: skapa / gå med / direktlänk
    ========================================================== */
    createBtn.onclick = async ()=>{
      nickname = (nameInput.value||"").trim() || (localStorage.getItem("nickname")||"").trim() || ((lang==="sv")?"Värd":"Host");
      localStorage.setItem("nickname", nickname);
      const word = (prompt((lang==="sv")?t.sv.enterWord:t.en.enterWord) || "").toUpperCase();
      if(!/^[A-ZÅÄÖ]+$/.test(word)) return alert("Endast bokstäver (A–Z, Å, Ä, Ö).");
      const id = "hangman-"+Math.random().toString(36).substr(2,5);
      await db.ref("games/"+id).set({
        word, guesses:[], wrong:0, over:false,
        players:{ host:nickname }, turn:"guest", scores:{host:0,guest:0},
        settings:{ timerSeconds:0 }, roundStartMs:0, winner:null,
        presence:{} /* NYTT: presence-mapp */
      });
      isHost = true; gameId = id;
      openGame();
      setupPresence(gameId, "host"); // NYTT
    };

    joinBtn.onclick = ()=>{ joinArea.classList.remove("hidden"); joinCodeInput.focus(); };

    joinGo.onclick = async ()=>{
      const code = (joinCodeInput.value||"").trim();
      if(!code) return alert((lang==="sv")?t.sv.joinCodeMissing:t.en.joinCodeMissing);
      nickname = ensureNamePrompt();
      const id = "hangman-"+code;
      showLoading(true);
      const snap = await db.ref("games/"+id).get();
      if(!snap.exists()){ showLoading(false); return alert((lang==="sv")?t.sv.notFound:t.en.notFound); }
      await db.ref("games/"+id+"/players").update({ guest:nickname });
      isHost = false; gameId = id;
      openGame();
      setupPresence(gameId, "guest"); // NYTT
      showLoading(false);
    };

    (async function handleDeepLink(){
      if(!deepLinkGame) return;
      startDiv.classList.add("hidden"); gameDiv.style.display="flex"; resizeCanvas();
      nickname = ensureNamePrompt();
      showLoading(true);
      const id = deepLinkGame;
      const snap = await db.ref("games/"+id).get();
      if(!snap.exists()){ showLoading(false); alert((lang==="sv")?t.sv.notFound:t.en.notFound); backToStart(false); return; }
      const data = snap.val();
      if(!data.players || !data.players.host){ showLoading(false); alert((lang==="sv")?t.sv.notFound:t.en.notFound); backToStart(false); return; }
      if(!data.players.guest){ await db.ref("games/"+id+"/players").update({ guest:nickname }); }
      isHost = false; gameId = id;
      initGameListeners();
      setupPresence(gameId, "guest"); // NYTT
      showLoading(false);
      updateShare();
    })();

    function openGame(){
      startDiv.classList.add("hidden");
      gameDiv.style.display="flex";
      resizeCanvas(); buildLetters(); initGameListeners(); updateShare();
      // När värd öppnar sitt spel: sätt presence (om inte via deep link)
      if(isHost) setupPresence(gameId, "host");
    }

    function updateShare(){
      const link = linkFor(gameId);
      shareEl.innerHTML = `${(lang==="sv")?t.sv.share:t.en.share}<a href="${link}" target="_blank" rel="noopener">${link}</a>`;
    }

    function backToStart(ask=true){
      const proceed = ask ? confirm((lang==="sv")?t.sv.confirmBack:t.en.confirmBack) : true;
      if(!proceed) return;
      if(gameId){ db.ref("games/"+gameId).remove().catch(()=>{}); }
      if(presenceRef){ presenceRef.remove().catch(()=>{}); presenceRef=null; } // NYTT: rensa presence
      stopTimerLoop();
      gameId=""; isHost=false;
      gameDiv.style.display="none"; startDiv.classList.remove("hidden");
      chatList.innerHTML=""; lettersEl.innerHTML=""; wordEl.textContent="_";
      scoreEl.textContent="🧑 0 | 👤 0"; turnEl.textContent="⏳"; timerBar.style.display="none";
      joinArea.classList.add("hidden");
    }
    backBtn.onclick = ()=> backToStart(true);

    /* =========================================================
       GAME LISTENERS
    ========================================================== */
    function initGameListeners(){
      buildLetters();
      // Chat
      db.ref("games/"+gameId+"/chat").limitToLast(50).on("child_added", s=> appendChat(s.val()));

      // All game data
      db.ref("games/"+gameId).on("value", async snap=>{
        const d = snap.val() || {};
        // Lobby/Presence (NYTT)
        updateLobbyBar(d.players||{}, d.presence||{});

        // de-dupe
        const key = JSON.stringify([d.guesses,d.wrong,d.over,d.turn,d.scores,d.settings,d.roundStartMs,d.winner]);
        if(key===lastUpdateKey) return; lastUpdateKey=key;

        // Timer
        timerSeconds = d.settings?.timerSeconds || 0;
        roundStartMs = d.roundStartMs || 0;
        showTimerControls(d);
        if(d.over || timerSeconds<=0){ stopTimerLoop(); timerBar.style.display = (timerSeconds>0 && !d.over)?"block":"none"; }
        else startTimerLoop();

        // Word/drawing/buttons
        showWord(d.word, d.guesses||[]);
        currentWrong = Number(d.wrong)||0; drawAll(currentWrong);
        const used = new Set(d.guesses||[]);
        lettersEl.querySelectorAll("button").forEach(b=>{ b.disabled = used.has(b.textContent); });

        // Score & turn
        scoreEl.textContent = `🧑 ${d.scores?.host||0} | 👤 ${d.scores?.guest||0}`;
        setTurn(d.turn);

        // Round end
        if(d.over){
          restartBtn.classList.remove("hidden");
          newWordBtn.classList.remove("hidden");
          const msg = d.winner==="host" ? ((lang==="sv")?t.sv.hostWon:t.en.hostWon) : ((lang==="sv")?t.sv.guestWon:t.en.guestWon);
          pushTemporaryInfo(msg);
        } else {
          restartBtn.classList.add("hidden");
          newWordBtn.classList.add("hidden");
        }
      });
    }

    function pushTemporaryInfo(text){ appendChat({name:"System", text, ts:Date.now()}); }

    // Restart / New word
    restartBtn.onclick = async ()=>{
      const s = await db.ref("games/"+gameId).get(); const d=s.val(); if(!d) return;
      await db.ref("games/"+gameId).update({ guesses:[], wrong:0, over:false, winner:null, roundStartMs: (timerSeconds>0? firebase.database.ServerValue.TIMESTAMP : 0) });
    };
    newWordBtn.onclick = async ()=>{
      const s=await db.ref("games/"+gameId).get(); const d=s.val(); if(!d?.over) return alert((lang==="sv")?"Rundan är inte slut än!":"Round not over yet!");
      const nw = (prompt((lang==="sv")?"Ange nytt ord:":"Enter new word:")||"").toUpperCase();
      if(!/^[A-ZÅÄÖ]+$/.test(nw)) return alert("Endast bokstäver (A–Z, Å, Ä, Ö).");
      const nextTurn = d.turn==="host" ? "guest":"host";
      await db.ref("games/"+gameId).update({
        word:nw, guesses:[], wrong:0, over:false, turn:nextTurn, winner:null,
        roundStartMs: (timerSeconds>0? firebase.database.ServerValue.TIMESTAMP : 0)
      });
    };

    // Init
    function onResizeInit(){ resizeCanvas(); }
    window.addEventListener("orientationchange", ()=>setTimeout(onResizeInit, 250));
    if(!deepLinkGame){ startDiv.classList.remove("hidden"); gameDiv.style.display="none"; }
  </script>
</body>
</html>
