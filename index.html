<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>H√ÑNGA GUBBE</title>
  <meta name="theme-color" content="#0e0e11">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>
  <style>
    :root{
      /* Grayscale palette */
      --grad-a:#e5e7eb; /* silver */
      --grad-b:#9ca3af; /* gray-400 */
      --bg1:#0e0e11;
      --bg2:#1a1a1f;
      --panel:rgba(255,255,255,.08);
      --text:#fff;
      --text-dim:#bdbdbd;
      --accent-shadow: rgba(180, 180, 180, .35);
      --accent-shadow-strong: rgba(210,210,210,.55);
      --gap:12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Poppins",sans-serif;
      color:var(--text);
      background:
        radial-gradient(circle at 20% 20%, #18181d, #0e0e11 70%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      min-height:100dvh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:12px;
      overflow-x:hidden;
      -webkit-tap-highlight-color:transparent;
    }
    h1{
      font-weight:700;
      text-align:center;
      margin:0;
      font-size:clamp(1.3rem,2.6vw,1.8rem);
      background:linear-gradient(135deg,var(--grad-a),var(--grad-b));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent
    }

    /* Card + responsive grid layout */
    .card{
      width:min(1100px,98vw);
      min-height:92dvh;
      background:var(--panel);
      border-radius:18px;
      backdrop-filter:blur(12px);
      box-shadow:0 0 25px rgba(0,0,0,.6);
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:var(--gap);
      overflow:visible
    }
    .hidden{display:none!important}
    .row{display:flex;gap:10px;align-items:center}
    .row>*{flex:1}

    input,select,button{
      font-family:inherit;
      font-size:1rem;
      border-radius:12px;
      border:1px solid #333;
      padding:.8rem 1rem;
      background:#222;
      color:#fff;
      width:100%
    }
    select{background:#1f1f24}

    button{
      cursor:pointer;
      font-weight:700;
      color:#111;
      border:none;
      background:linear-gradient(135deg,var(--grad-a),var(--grad-b));
      box-shadow:0 6px 18px var(--accent-shadow);
      transition:all .15s
    }
    button:hover{transform:translateY(-2px)}
    button:disabled{opacity:.5;cursor:not-allowed}

    /* Lobby bar */
    #lobbyBar{
      position:sticky;top:0;z-index:10;
      background:rgba(0,0,0,.12);
      border:1px solid #2b2b30;
      border-radius:12px;padding:8px;
      display:flex;gap:12px;justify-content:center;align-items:center;flex-wrap:wrap
    }
    .lobbyItem{display:flex;align-items:center;gap:8px}
    #lobbyMsg{color:var(--text-dim);font-size:.9rem}
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
    .online{background:#22c55e}.offline{background:#ef4444}

    /* Main area as responsive two-column on desktop */
    #gameMain{flex:1;display:flex;flex-direction:column;gap:14px;padding:6px}
    .gameGrid{
      display:grid;gap:14px;
      grid-template-columns:1fr;
      align-items:start
    }
    @media (min-width: 1024px){
      .gameGrid{grid-template-columns: 1.2fr .8fr}
    }

    #share{text-align:center;font-size:.9rem;color:var(--text-dim);margin:6px 0 10px;word-break:break-all}
    #scoreboard{text-align:center;font-weight:700;font-size:1.1rem;background:linear-gradient(135deg,var(--grad-a),var(--grad-b));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    #turnIndicator{text-align:center;font-weight:600;color:var(--text-dim)}

    /* Left column (canvas + word + letters) */
    .leftCol{display:flex;flex-direction:column;gap:12px}
    #hangman{
      width:100%;background:#111;border:1px solid #333;border-radius:12px;
      max-height:40dvh;min-height:240px
    }
    #word{text-align:center;letter-spacing:.25em;font-size:1.35rem;margin-top:4px}

    #letters{display:grid;gap:10px;margin:10px 0}
    #letters{grid-template-columns:repeat(12,1fr)}
    #letters button{font-weight:800}
    @media (hover:hover) and (pointer:fine){
      #letters button:hover:not(:disabled){
        box-shadow:0 0 12px var(--accent-shadow-strong), 0 0 18px var(--accent-shadow);
        transform:translateY(-3px) scale(1.04)
      }
    }
    #letters button:disabled{filter:saturate(.7)}

    @media (max-width:959px){#letters{grid-template-columns:repeat(8,1fr)}}
    @media (max-width:600px){#letters{grid-template-columns:repeat(7,1fr);margin-bottom:40px}#hangman{max-height:38dvh}}
    @media (max-width:420px){#letters{grid-template-columns:repeat(6,1fr)}}
    @media (min-width:960px){
      .card{padding-top:10px}
      #gameMain,#hangman,#letters,#chatWrap,#actions{max-width:1000px;margin:auto}
      #hangman{max-height:calc(70vh - 180px)}
    }

    /* Timer */
    #timerBar{width:100%;height:10px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden;display:none}
    #timerFill{height:100%;width:0;background:linear-gradient(90deg,var(--grad-a),var(--grad-b));transition:width .2s,filter .2s}
    .pulse{animation:pulse .8s ease-in-out infinite}
    @keyframes pulse{0%{filter:brightness(1)}50%{filter:brightness(1.5)}100%{filter:brightness(1)}}

    .shake{animation:shake .28s ease}
    @keyframes shake{
      0%{transform:translateX(0)}25%{transform:translateX(-4px)}50%{transform:translateX(4px)}75%{transform:translateX(-3px)}100%{transform:translateX(0)}
    }

    /* Right column (chat + actions) */
    .rightCol{display:flex;flex-direction:column;gap:12px}
    #chatWrap{border:1px solid #2b2b30;border-radius:12px;background:rgba(255,255,255,.05);padding:10px;display:flex;flex-direction:column;gap:8px;min-height:260px}
    #chatList{flex:1;max-height:28dvh;overflow-y:auto;display:flex;flex-direction:column;gap:6px}
    .chatMsg{background:rgba(255,255,255,.06);border:1px solid #35353a;border-radius:10px;padding:6px;font-size:.95rem}
    .chatMeta{font-size:.75rem;color:var(--text-dim);margin-top:2px}
    .fadeout{opacity:0;transition:opacity .6s}
    #actions{display:flex;gap:8px;justify-content:center;margin-top:2px;flex-wrap:wrap}

    /* Start screen tweaks for breathing room */
    .startGrid{display:grid;gap:12px;grid-template-columns:1fr}
    @media (min-width:700px){
      .startGrid{grid-template-columns:1fr 1fr}
    }
    .full{grid-column:1 / -1}
  </style>
</head>
<body>
  <!-- Start -->
  <div id="start" class="card">
    <h1 id="titleTop">H√ÑNGA GUBBE</h1>
    <div class="startGrid">
      <div>
        <label for="lang" id="langLabel">Spr√•k / Language</label>
        <select id="lang"><option value="sv">Svenska</option><option value="en">English</option></select>
      </div>
      <div>
        <label for="playerName" id="nameLabel">Ditt namn</label>
        <input id="playerName" maxlength="24"/>
      </div>

      <div class="row full">
        <button id="createBtn">üÜï Skapa spel</button>
        <button id="joinBtn">üîó G√• med i spel</button>
      </div>

      <div id="joinArea" class="row hidden full">
        <input id="joinCode" placeholder="Kod (t.ex. ab123)" maxlength="10"/>
        <button id="joinGo">G√• med</button>
      </div>
    </div>
  </div>

  <!-- Game -->
  <div id="game" class="card hidden">
    <div id="lobbyBar">
      <div class="lobbyItem"><span id="dotHost" class="dot offline"></span>üëë <span id="nameHost">‚Äî</span></div>
      <div class="lobbyItem"><span id="dotGuest" class="dot offline"></span>üë§ <span id="nameGuest">‚è≥ V√§ntar‚Ä¶</span></div>
      <div id="lobbyMsg" class="lobbyItem">‚Äî</div>
    </div>

    <div id="gameMain">
      <h1 id="titleGame">H√ÑNGA GUBBE</h1>
      <div id="share"></div>
      <div id="scoreboard">üßë 0 | üë§ 0</div>
      <div id="turnIndicator">‚è≥ V√§ntar p√• tur‚Ä¶</div>

      <div class="gameGrid">
        <!-- Left column -->
        <div class="leftCol">
          <canvas id="hangman"></canvas>
          <div id="word">_</div>

          <div class="row" id="timerControlsRow" style="justify-content:center;flex-wrap:wrap">
            <button id="timerOpen" class="hidden" style="max-width:220px">‚è± St√§ll in timer</button>
            <div id="timerConfig" class="row hidden" style="max-width:520px;width:100%">
              <input id="timerInput" type="number" min="0" max="100" value="0"/>
              <button id="timerConfirm">‚úÖ</button>
              <button id="timerCancel">‚úñ</button>
              <button id="timerOff">üïí Av</button>
            </div>
          </div>

          <div id="timerBar"><div id="timerFill"></div></div>
          <div id="letters"></div>
        </div>

        <!-- Right column -->
        <div class="rightCol">
          <div id="chatWrap">
            <div id="chatList"></div>
            <div class="row">
              <input id="chatText" placeholder="Skriv ett meddelande..." maxlength="200"/>
              <button id="chatSend">Skicka</button>
            </div>
          </div>
          <div id="actions">
            <button id="newWordBtn" class="hidden">‚úçÔ∏è V√§lj nytt ord</button>
            <button id="backBtn">‚¨ÖÔ∏è Tillbaka</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Name modal -->
  <div id="nameModal" style="position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:9999;padding:16px">
    <div style="width:min(440px,92vw);background:rgba(20,20,24,.97);border:1px solid #333;border-radius:14px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.6)">
      <h2 id="nameModalTitle" style="margin:0 0 8px;font-size:1.1rem">V√§lj ett namn</h2>
      <p id="nameModalDesc" style="margin:0 0 10px;color:#bdbdbd;font-size:.95rem">Du m√•ste ange ett namn f√∂r att g√• vidare.</p>
      <input id="nameModalInput" maxlength="24" style="width:100%;font-family:inherit;font-size:1rem;border-radius:12px;border:1px solid #333;padding:.8rem 1rem;background:#222;color:#fff"/>
      <div class="row" style="margin-top:10px"><button id="nameModalConfirm">OK</button></div>
    </div>
  </div>

  <script>
    /* ---------- Firebase ---------- */
    const firebaseConfig={
      apiKey:"AIzaSyAN9URR47HIBwIuBP3kSu5Rv_Ys0ef72-Q",
      authDomain:"hangman-6a99e.firebaseapp.com",
      databaseURL:"https://hangman-6a99e-default-rtdb.europe-west1.firebasedatabase.app",
      projectId:"hangman-6a99e",
      storageBucket:"hangman-6a99e.firebasestorage.app",
      messagingSenderId:"992689481911",
      appId:"1:992689481911:web:6461e931ba4d96879ec532"
    };
    firebase.initializeApp(firebaseConfig);
    const db=firebase.database();

    /* ---------- DOM ---------- */
    const startDiv=document.getElementById("start"),
          gameDiv=document.getElementById("game"),
          gameMain=document.getElementById("gameMain"),
          langSel=document.getElementById("lang"),
          langLabel=document.getElementById("langLabel"),
          titleTop=document.getElementById("titleTop"),
          titleGame=document.getElementById("titleGame"),
          nameInput=document.getElementById("playerName"),
          nameLabel=document.getElementById("nameLabel"),
          createBtn=document.getElementById("createBtn"),
          joinBtn=document.getElementById("joinBtn"),
          joinArea=document.getElementById("joinArea"),
          joinCodeInput=document.getElementById("joinCode"),
          joinGo=document.getElementById("joinGo"),
          nameHost=document.getElementById("nameHost"),
          nameGuest=document.getElementById("nameGuest"),
          dotHost=document.getElementById("dotHost"),
          dotGuest=document.getElementById("dotGuest"),
          lobbyMsg=document.getElementById("lobbyMsg"),
          shareEl=document.getElementById("share"),
          scoreEl=document.getElementById("scoreboard"),
          turnEl=document.getElementById("turnIndicator"),
          canvas=document.getElementById("hangman"),
          ctx=canvas.getContext("2d"),
          wordEl=document.getElementById("word"),
          lettersEl=document.getElementById("letters"),
          chatList=document.getElementById("chatList"),
          chatText=document.getElementById("chatText"),
          chatSend=document.getElementById("chatSend"),
          timerOpen=document.getElementById("timerOpen"),
          timerConfig=document.getElementById("timerConfig"),
          timerInput=document.getElementById("timerInput"),
          timerConfirm=document.getElementById("timerConfirm"),
          timerCancel=document.getElementById("timerCancel"),
          timerOff=document.getElementById("timerOff"),
          timerBar=document.getElementById("timerBar"),
          timerFill=document.getElementById("timerFill"),
          newWordBtn=document.getElementById("newWordBtn"),
          backBtn=document.getElementById("backBtn"),
          nameModal=document.getElementById("nameModal"),
          nameModalInput=document.getElementById("nameModalInput"),
          nameModalConfirm=document.getElementById("nameModalConfirm");

    /* ---------- State ---------- */
    const params=new URLSearchParams(location.search),deepLinkGame=params.get("game");
    const letters=[..."ABCDEFGHIJKLMNOPQRSTUVWXYZ√Ö√Ñ√ñ"];
    let gameId="",isHost=!1,nickname="",lang=localStorage.getItem("lang")||"sv",timerSeconds=0,roundStartMs=0,rafTimer=null,currentWrong=0,lastUpdateKey="";
    const T={
      sv:{
        appTitle:"H√ÑNGA GUBBE",
        appTitleEn:"HANGMAN", /* used when switching title while lang=en */
        nameLabel:"Ditt namn",
        langLabel:"Spr√•k / Language",
        enterWord:"Ange ett ord att spela med:",
        notFound:"Spelet hittades inte.",
        notYourTurn:"Inte din tur!",
        share:"Dela denna l√§nk:",
        loading:"Laddar spel‚Ä¶",
        yourTurn:"üéØ Din tur!",
        oppTurn:"‚è≥ Motst√•ndarens tur‚Ä¶",
        timeRanOut:"‚è∞ Tiden tog slut!",
        hostWon:"üéâ V√§rden vann!",
        guestWon:"üéâ G√§sten vann!",
        joinCodeMissing:"Ange spelkod.",
        confirmBack:"√Ñr du s√§ker p√• att du vill l√§mna och radera spelet?",
        waiting:"‚è≥ V√§ntar p√• spelare‚Ä¶",
        bothIn:"üéÆ B√•da spelare anslutna!",
        chooseWordCta:"‚úçÔ∏è V√§lj nytt ord",
        back:"‚¨ÖÔ∏è Tillbaka",
        create:"üÜï Skapa spel",
        join:"üîó G√• med i spel",
        joinGo:"G√• med",
        joinPlaceholder:"Kod (t.ex. ab123)",
        chatPlaceholder:"Skriv ett meddelande...",
        chatSend:"Skicka",
        timerOpen:"‚è± St√§ll in timer",
        timerOff:"üïí Av",
        modalTitle:"V√§lj ett namn",
        modalDesc:"Du m√•ste ange ett namn f√∂r att g√• vidare.",
        modalPlaceholder:"Ditt namn",
        chooserOnly:"Bara ordgivaren kan starta n√§sta runda.",
        roundNotOver:"Rundan √§r inte slut √§n."
      },
      en:{
        appTitle:"HANGMAN",
        appTitleEn:"HANGMAN",
        nameLabel:"Your name",
        langLabel:"Language",
        enterWord:"Enter a word to start:",
        notFound:"Game not found.",
        notYourTurn:"Not your turn!",
        share:"Share this link:",
        loading:"Loading game‚Ä¶",
        yourTurn:"üéØ Your turn!",
        oppTurn:"‚è≥ Opponent's turn‚Ä¶",
        timeRanOut:"‚è∞ Time ran out!",
        hostWon:"üéâ Host won!",
        guestWon:"üéâ Guest won!",
        joinCodeMissing:"Enter a game code.",
        confirmBack:"Are you sure you want to leave and delete the game?",
        waiting:"‚è≥ Waiting for player‚Ä¶",
        bothIn:"üéÆ Both players connected!",
        chooseWordCta:"‚úçÔ∏è Pick new word",
        back:"‚¨ÖÔ∏è Back",
        create:"üÜï Create game",
        join:"üîó Join game",
        joinGo:"Join",
        joinPlaceholder:"Code (e.g. ab123)",
        chatPlaceholder:"Type a message...",
        chatSend:"Send",
        timerOpen:"‚è± Set timer",
        timerOff:"üïí Off",
        modalTitle:"Choose a name",
        modalDesc:"You must enter a name to continue.",
        modalPlaceholder:"Your name",
        chooserOnly:"Only the word chooser can start the next round.",
        roundNotOver:"Round not over."
      }
    };

    /* ---------- i18n ---------- */
    langSel.value=lang;
    function applyLang(){
      const L=T[lang];
      document.documentElement.lang = (lang==='sv'?'sv':'en');
      titleTop.textContent = L.appTitle;
      titleGame.textContent = L.appTitle;
      nameLabel.textContent = L.nameLabel;
      langLabel.textContent = L.langLabel;
      createBtn.textContent = L.create;
      joinBtn.textContent = L.join;
      joinGo.textContent = L.joinGo;
      joinCodeInput.placeholder = L.joinPlaceholder;
      chatText.placeholder = L.chatPlaceholder;
      chatSend.textContent = L.chatSend;
      newWordBtn.textContent = L.chooseWordCta;
      backBtn.textContent = L.back;
      document.getElementById("nameModalTitle").textContent = L.modalTitle;
      document.getElementById("nameModalDesc").textContent = L.modalDesc;
      nameModalInput.placeholder = L.modalPlaceholder;
      document.getElementById("timerOpen").textContent = L.timerOpen;
      document.getElementById("timerOff").textContent = L.timerOff;
    }
    applyLang();
    langSel.onchange=()=>{
      lang=langSel.value; localStorage.setItem("lang",lang); applyLang(); updateShareText();
      // Update lobby "waiting..." if needed
      nameGuest.textContent = (nameGuest.dataset.hasGuest==="1") ? nameGuest.textContent : T[lang].waiting;
    };

    /* ---------- Helpers ---------- */
    const escapeH=s=>(s||"").replace(/[&<>\"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m]));
    const shareLink=()=>location.origin+location.pathname+"?game="+gameId;

    function requireNickname(){
      let stored=(nameInput.value||localStorage.getItem("nickname")||"").trim();
      if(stored){ nameInput.value=stored; localStorage.setItem("nickname",stored); return Promise.resolve(stored) }
      return new Promise(res=>{
        nameModal.style.display="flex"; nameModalInput.value="";
        setTimeout(()=>nameModalInput.focus(),40);
        function done(){
          let v=(nameModalInput.value||"").trim(); if(!v)return;
          nameModal.style.display="none"; nameInput.value=v; localStorage.setItem("nickname",v); res(v)
        }
        nameModalConfirm.onclick=done; nameModalInput.onkeydown=e=>{"Enter"===e.key&&done()}
      })
    }

    function updateLobby(p={},pr={}){
      nameHost.textContent=p.host||"‚Äî";
      const hasGuest = !!p.guest;
      nameGuest.textContent=hasGuest ? p.guest : T[lang].waiting;
      nameGuest.dataset.hasGuest = hasGuest ? "1" : "0";
      const h=!!pr.host,g=!!pr.guest;
      dotHost.classList.toggle("online",h); dotHost.classList.toggle("offline",!h);
      dotGuest.classList.toggle("online",g); dotGuest.classList.toggle("offline",!g);
      lobbyMsg.textContent=(p.host&&p.guest)?T[lang].bothIn:T[lang].waiting
    }
    function setupPresence(role){
      firebase.database().ref(".info/connected").on("value",s=>{
        if(s.val()){
          const r=db.ref(`games/${gameId}/presence/${role}`); r.set(!0); r.onDisconnect().remove()
        }
      })
    }

    /* ---------- Canvas sizing/drawing ---------- */
    function resizeCanvas(){
      const w=Math.min(900,Math.floor(gameMain.clientWidth));
      const h=Math.floor(Math.min(w*1.25,(window.innerHeight*0.7)-180));
      canvas.width=Math.max(240,Math.min(w,900));
      canvas.height=Math.max(240,h);
      drawAll(currentWrong);
      canvas.style.maxWidth="100%"; canvas.style.height="auto"
    }
    window.addEventListener("resize",()=>setTimeout(resizeCanvas,60));

    const grad=()=>{
      const g=ctx.createLinearGradient(0,0,canvas.width,canvas.height);
      g.addColorStop(0,getComputedStyle(document.documentElement).getPropertyValue('--grad-a').trim());
      g.addColorStop(.5,getComputedStyle(document.documentElement).getPropertyValue('--grad-b').trim());
      g.addColorStop(1,getComputedStyle(document.documentElement).getPropertyValue('--grad-a').trim());
      return g
    };
    function drawAll(w){
      const cw=canvas.width,ch=canvas.height,sX=cw/200,sY=ch/250,lw=2*Math.min(sX,sY);
      ctx.clearRect(0,0,cw,ch); ctx.lineWidth=lw; ctx.strokeStyle=grad();
      ctx.beginPath(); // gallows
      ctx.moveTo(10*sX,240*sY);ctx.lineTo(190*sX,240*sY);
      ctx.moveTo(50*sX,240*sY);ctx.lineTo(50*sX,20*sY);ctx.lineTo(130*sX,20*sY);ctx.lineTo(130*sX,50*sY);
      ctx.stroke();
      if(w>0){ctx.beginPath();ctx.arc(130*sX,70*sY,20*sX,0,Math.PI*2);ctx.stroke()}      // head
      if(w>1){ctx.beginPath();ctx.moveTo(130*sX,90*sY);ctx.lineTo(130*sX,160*sY);ctx.stroke()} // body
      if(w>2){ctx.beginPath();ctx.moveTo(130*sX,110*sY);ctx.lineTo(100*sX,140*sY);ctx.stroke()} // arm L
      if(w>3){ctx.beginPath();ctx.moveTo(130*sX,110*sY);ctx.lineTo(160*sX,140*sY);ctx.stroke()} // arm R
      if(w>4){ctx.beginPath();ctx.moveTo(130*sX,160*sY);ctx.lineTo(110*sX,200*sY);ctx.stroke()} // leg L
      if(w>5){ctx.beginPath();ctx.moveTo(130*sX,160*sY);ctx.lineTo(150*sX,200*sY);ctx.stroke()} // leg R
    }
    function setWordDisplay(word,guesses){
      wordEl.textContent=word.split("").map(l=>guesses.includes(l)?l:"_").join(" ")
    }

    /* ---------- Letters ---------- */
    function buildLetters(){
      lettersEl.innerHTML="";
      letters.forEach(ch=>{
        const b=document.createElement("button");
        b.textContent=ch;
        b.dataset.letter=ch;
        b.onclick=onGuess;
        lettersEl.appendChild(b)
      })
    }

    async function onGuess(){
      const ch=this.textContent;
      const snap=await db.ref("games/"+gameId).get(),d=snap.val();
      if(!d || d.over || d.awaitingWordBy){ return } // locked when over or awaiting word
      const mine=isHost?"host":"guest";
      if(d.turn!==mine){ return } // not your turn: buttons are disabled already
      if((d.guesses||[]).includes(ch))return;

      let newGuesses=[...(d.guesses||[]),ch],newWrong=d.wrong||0,over=!1,winner=null;
      const scores={...(d.scores||{host:0,guest:0})};
      const isWrong=!d.word.includes(ch);
      if(isWrong){
        newWrong++; canvas.classList.add("shake"); setTimeout(()=>canvas.classList.remove("shake"),300)
      }
      const solved=d.word.split("").every(l=>newGuesses.includes(l));
      if(solved){ over=!0; winner=mine; scores[mine]=(scores[mine]||0)+1 }
      else if(newWrong>=6){ over=!0; const opp=mine==="host"?"guest":"host"; winner=opp; scores[opp]=(scores[opp]||0)+1 }

      const patch={guesses:newGuesses,wrong:newWrong,over,scores,winner,roundStartMs:firebase.database.ServerValue.TIMESTAMP};
      // If round finished, set who must choose next word: the current guesser (mine).
      if(over){ patch.awaitingWordBy = mine }
      await db.ref("games/"+gameId).update(patch)
    }

    /* ---------- Timer ---------- */
    function stopTimerLoop(){ if(rafTimer)cancelAnimationFrame(rafTimer); rafTimer=null }
    function timerLoop(){
      stopTimerLoop();
      if(timerSeconds<=0||!roundStartMs){ timerBar.style.display="none"; return }
      timerBar.style.display="block";
      const tick=async()=>{
        const now=Date.now(),remainMs=Math.max(0,timerSeconds*1000-Math.max(0,now-roundStartMs)),pct=Math.max(0,Math.min(1,remainMs/(timerSeconds*1000)));
        timerFill.style.width=pct*100+"%"; timerFill.classList.toggle("pulse",remainMs<=3000);
        if(remainMs<=0){
          const snap=await db.ref("games/"+gameId).get(),d=snap.val();
          if(d && !d.over){
            const opp=("host"===d.turn)?"guest":"host",scores={...(d.scores||{})};
            scores[opp]=(scores[opp]||0)+1;
            await db.ref("games/"+gameId).update({over:!0,scores,winner:opp,awaitingWordBy:d.turn});
            addChat({name:"System",text:(lang==="sv")?T.sv.timeRanOut:T.en.timeRanOut,ts:Date.now()})
          }
          timerBar.style.display="none"; return
        }
        rafTimer=requestAnimationFrame(tick)
      };
      rafTimer=requestAnimationFrame(tick)
    }

    /* ---------- Chat ---------- */
    function pushChat(m){ db.ref("games/"+gameId+"/chat").push({name:nickname,text:m,ts:Date.now()}) }
    chatSend.onclick=()=>{ const v=chatText.value.trim(); if(!v)return; chatText.value=""; pushChat(v) };
    chatText.onkeydown=e=>{"Enter"===e.key&&chatSend.click()};
    function addChat(o){
      const wrap=document.createElement("div");
      wrap.className="chatMsg";
      wrap.innerHTML=`<div><b>${escapeH(o.name||"??")}</b>: ${escapeH(o.text||"")}</div><div class="chatMeta">${new Date(o.ts||Date.now()).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div>`;
      chatList.appendChild(wrap); chatList.scrollTop=chatList.scrollHeight;
      setTimeout(()=>wrap.classList.add("fadeout"),15000); setTimeout(()=>wrap.remove(),16500)
    }

    function setTurn(turn){
      const mine=isHost?"host":"guest";
      turnEl.textContent=(turn===mine)?((lang==="sv")?T.sv.yourTurn:T.en.yourTurn):((lang==="sv")?T.sv.oppTurn:T.en.oppTurn);
      turnEl.style.opacity=".3"; setTimeout(()=>turnEl.style.opacity="1",120)
    }

    /* ---------- UI enable/disable helpers ---------- */
    function setLettersEnabled(enabled){
      lettersEl.querySelectorAll("button").forEach(b=>b.disabled=!enabled || b.dataset.used==="1")
    }
    function setAllInteractiveDisabled(disabled){
      // main interactivity: letters and timer config; chat stays enabled
      setLettersEnabled(!disabled);
      [timerOpen,timerConfirm,timerCancel,timerOff,timerInput].forEach(el=>{ if(el) el.disabled=disabled })
    }

    function updateShareText(){
      const L=T[lang]; const link=shareLink();
      shareEl.innerHTML=`${L.share} <a href="${link}" target="_blank" rel="noopener">${link}</a>`;
    }

    function showGame(){
      startDiv.classList.add("hidden"); gameDiv.classList.remove("hidden");
      resizeCanvas(); buildLetters(); updateShareText();
    }

    /* ---------- Navigation ---------- */
    backBtn.onclick=()=>{ if(!confirm(T[lang].confirmBack))return; if(gameId)db.ref("games/"+gameId).remove(); location.href=location.pathname };

    /* ---------- Create / Join ---------- */
    createBtn.onclick=async()=>{
      nickname=(nameInput.value||"").trim(); if(!nickname)nickname=await requireNickname();
      const word=(prompt(T[lang].enterWord)||"").toUpperCase();
      if(!/^[A-Z√Ö√Ñ√ñ]+$/.test(word))return alert("Endast bokst√§ver A‚Äì√ñ!");
      const id="hangman-"+Math.random().toString(36).substr(2,5);
      await db.ref("games/"+id).set({
        word,guesses:[],wrong:0,turn:"guest",over:!1,
        players:{host:nickname},scores:{host:0,guest:0},
        settings:{timerSeconds:0},presence:{},roundStartMs:0,
        awaitingWordBy:null
      });
      isHost=!0; gameId=id; showGame(); setupPresence("host"); listenGame()
    };

    joinBtn.onclick=()=>joinArea.classList.remove("hidden");

    joinGo.onclick=async()=>{
      const code=(joinCodeInput.value||"").trim();
      if(!code) return alert(T[lang].joinCodeMissing);
      nickname=(nameInput.value||"").trim(); if(!nickname)nickname=await requireNickname();
      const id="hangman-"+code;
      const snap=await db.ref("games/"+id).get();
      if(!snap.exists())return alert(T[lang].notFound);
      await db.ref("games/"+id+"/players").update({guest:nickname});
      isHost=!1; gameId=id; showGame(); setupPresence("guest"); listenGame()
    };

    (async function directJoin(){
      if(!deepLinkGame)return;
      showGame(); nickname=(nameInput.value||"").trim(); if(!nickname)nickname=await requireNickname();
      const snap=await db.ref("games/"+deepLinkGame).get();
      if(!snap.exists())return backBtn.click();
      const d=snap.val();
      if(!d.players?.guest){ await db.ref("games/"+deepLinkGame+"/players").update({guest:nickname}) }
      isHost=!1; gameId=deepLinkGame; setupPresence("guest"); listenGame()
    })();

    /* ---------- Game listener ---------- */
    function listenGame(){
      if(!gameId)return;

      db.ref("games/"+gameId+"/chat").limitToLast(50).on("child_added",s=>addChat(s.val()));

      db.ref("games/"+gameId).on("value",snap=>{
        const d=snap.val(); if(!d)return;

        updateLobby(d.players||{},d.presence||{});

        const key=JSON.stringify([d.guesses,d.wrong,d.over,d.turn,d.scores,d.settings,d.roundStartMs,d.winner,d.awaitingWordBy]);
        if(key===lastUpdateKey) return; lastUpdateKey=key;

        timerSeconds=d.settings?.timerSeconds||0; roundStartMs=d.roundStartMs||0;
        (d.over||timerSeconds<=0)?(stopTimerLoop(),timerBar.style.display=(timerSeconds>0&&!d.over)?"block":"none"):timerLoop();

        setWordDisplay(d.word,d.guesses||[]); currentWrong=d.wrong||0; drawAll(currentWrong);

        // mark used letters
        const used=new Set(d.guesses||[]);
        lettersEl.querySelectorAll("button").forEach(b=>{
          const usedNow=used.has(b.textContent);
          b.disabled = usedNow; b.dataset.used=usedNow?"1":"0";
        });

        // scores & turn
        scoreEl.textContent=`üßë ${d.scores?.host||0} | üë§ ${d.scores?.guest||0}`;
        setTurn(d.turn);
        updateShareText();

        /* ----- Post-round lock + chooser control ----- */
        const mine=isHost?"host":"guest";
        const chooser = d.awaitingWordBy || null;
        const isChooser = chooser && chooser===mine;

        // By default enable only when: not over, not awaiting word, and it's my turn.
        const myTurnActive = (!d.over && !chooser && d.turn===mine);
        setAllInteractiveDisabled(!myTurnActive);

        // If awaiting a word: only chooser sees the "Pick new word" button; everyone else is locked.
        if(chooser){
          newWordBtn.classList.remove("hidden");
          newWordBtn.disabled = !isChooser;
          if(!isChooser){
            // ensure letters/timer are off
            setAllInteractiveDisabled(true);
            // Show a subtle hint in chat stream once per state change
            addChat({name:"System", text:(lang==="sv")?T.sv.chooserOnly:T.en.chooserOnly, ts:Date.now()});
          }
        }else{
          // not awaiting: hide the button unless round just ended (we handle below)
          newWordBtn.classList.add("hidden");
        }

        // If round just ended (over=true), set button visibility based on awaitingWordBy (set on win/lose)
        if(d.over){
          // Ensure letters are disabled on round end
          setAllInteractiveDisabled(true);
          // show winner message once via chat
          if(d.winner){
            addChat({name:"System",text:(d.winner==="host")?((lang==="sv")?T.sv.hostWon:T.en.hostWon):((lang==="sv")?T.sv.guestWon:T.en.guestWon),ts:Date.now()})
          }
        }
      })
    }

    /* ---------- New word flow (chooser only) ---------- */
    newWordBtn.onclick=async()=>{
      const s=await db.ref("games/"+gameId).get(),d=s.val(); if(!d) return;
      if(!d.over && !d.awaitingWordBy) return alert((lang==="sv")?T.sv.roundNotOver:T.en.roundNotOver);

      const mine=isHost?"host":"guest";
      if(d.awaitingWordBy!==mine) return alert((lang==="sv")?T.sv.chooserOnly:T.en.chooserOnly);

      const nw=(prompt(T[lang].enterWord)||"").toUpperCase();
      if(!/^[A-Z√Ö√Ñ√ñ]+$/.test(nw)) return;

      // Next round: guesser is the opposite of chooser
      const nextTurn = (mine==="host")?"guest":"host";

      await db.ref("games/"+gameId).update({
        word:nw,guesses:[],wrong:0,over:!1,winner:null,
        turn:nextTurn, roundStartMs:(timerSeconds>0?Date.now():0),
        awaitingWordBy:null
      });
      // after setting new word, hide the button locally until state update arrives
      newWordBtn.classList.add("hidden");
    };

    /* ---------- Timer controls ---------- */
    timerOpen.onclick=()=>{timerConfig.classList.remove("hidden");timerOpen.classList.add("hidden")};
    timerCancel.onclick=()=>{timerConfig.classList.add("hidden");timerOpen.classList.remove("hidden")};
    timerConfirm.onclick=async()=>{
      const v=Math.max(0,Math.min(100,Number(timerInput.value||0)));
      await db.ref("games/"+gameId+"/settings").update({timerSeconds:v});
      await db.ref("games/"+gameId).update({roundStartMs:firebase.database.ServerValue.TIMESTAMP});
      timerConfig.classList.add("hidden")
    };
    timerOff.onclick=async()=>{
      await db.ref("games/"+gameId+"/settings").update({timerSeconds:0});
      await db.ref("games/"+gameId).update({roundStartMs:0});
      timerConfig.classList.add("hidden");timerOpen.classList.remove("hidden")
    };

    /* ---------- Load ---------- */
    window.addEventListener("load",()=>{
      if(!deepLinkGame){ startDiv.classList.remove("hidden"); gameDiv.classList.add("hidden") }
      resizeCanvas()
    });
  </script>
</body>
</html>
